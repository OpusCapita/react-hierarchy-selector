"use strict";

exports.__esModule = true;
exports["default"] = void 0;

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/* eslint-disable no-param-reassign */
var index = new WeakMap();

function getHashFromIds(ids) {
  return ids.join('_');
}

function getIdsFromHash(hash) {
  return hash ? hash.split('_') : [];
}

function getFromIndex(obj, ids) {
  var dataIndex = index.get(obj);
  var hash = getHashFromIds(ids);
  return dataIndex[hash] ? Object.assign({}, dataIndex[hash]) : null;
}

function getParents(obj, hash, parents) {
  if (parents === void 0) {
    parents = [];
  }

  var ids = getIdsFromHash(hash);

  if (ids.length > 1) {
    ids.pop();
    var newHash = getHashFromIds(ids);
    var dataIndex = index.get(obj);
    if (dataIndex[newHash] === undefined) throw new Error("Hash '" + newHash + "' is missed from an index");
    parents.unshift(dataIndex[newHash].item);
    getParents(obj, newHash, parents);
  }

  return parents;
}

function addIdToHash(hash, addedId) {
  var ids = getIdsFromHash(hash);
  return getHashFromIds([].concat(ids, [addedId]));
}

function createIndex(items, indexResult, parents) {
  if (indexResult === void 0) {
    indexResult = {};
  }

  if (parents === void 0) {
    parents = [];
  }

  Object.keys(items).forEach(function (key) {
    var item = items[key];
    var allIds = [].concat(parents, [item.id]);
    var hashKey = getHashFromIds(allIds);
    indexResult[hashKey] = {
      parentHash: getHashFromIds(parents),
      item: item
    };

    if (item.children && Array.isArray(item.children) && item.children.length > 0) {
      createIndex(item.children, indexResult, allIds);
    }
  });
  return indexResult;
}

var DataIndex = function DataIndex(data) {
  var _this = this;

  _defineProperty(this, "get", function () {
    return Object.assign({}, index.get(_this));
  });

  _defineProperty(this, "getHash", function (indexItem) {
    if (!indexItem) throw new Error('DataIndex::getParents(): there is no indexItem');
    if (!indexItem.item) throw new Error('DataIndex::getParents(): item is not found in indexItem');
    return addIdToHash(indexItem.parentHash, indexItem.item.id);
  });

  _defineProperty(this, "getHashFromIds", function (ids) {
    return getHashFromIds(ids);
  });

  _defineProperty(this, "getParentsByHash", function (hash) {
    return getParents(_this, hash);
  });

  _defineProperty(this, "getParents", function (indexItem) {
    return getParents(_this, _this.getHash(indexItem));
  });

  _defineProperty(this, "getFromIndex", function (parentIds, id) {
    return getFromIndex(_this, [].concat(parentIds, [id]));
  });

  _defineProperty(this, "clone", function () {
    return new DataIndex(_this);
  });

  _defineProperty(this, "forEach", function (callBack) {
    var dataIndex = index.get(_this);
    Object.keys(dataIndex).forEach(function (key) {
      var indexItem = dataIndex[key];
      callBack(indexItem.item, getIdsFromHash(indexItem.parentHash));
    });
  });

  if (data instanceof DataIndex) {
    index.set(this, data.get());
  } else {
    index.set(this, createIndex(data));
  }
};

exports["default"] = DataIndex;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tb2RlbHMvZGF0YS1pbmRleC5qcyJdLCJuYW1lcyI6WyJpbmRleCIsIldlYWtNYXAiLCJnZXRIYXNoRnJvbUlkcyIsImlkcyIsImpvaW4iLCJnZXRJZHNGcm9tSGFzaCIsImhhc2giLCJzcGxpdCIsImdldEZyb21JbmRleCIsIm9iaiIsImRhdGFJbmRleCIsImdldCIsIk9iamVjdCIsImFzc2lnbiIsImdldFBhcmVudHMiLCJwYXJlbnRzIiwibGVuZ3RoIiwicG9wIiwibmV3SGFzaCIsInVuZGVmaW5lZCIsIkVycm9yIiwidW5zaGlmdCIsIml0ZW0iLCJhZGRJZFRvSGFzaCIsImFkZGVkSWQiLCJjcmVhdGVJbmRleCIsIml0ZW1zIiwiaW5kZXhSZXN1bHQiLCJrZXlzIiwiZm9yRWFjaCIsImtleSIsImFsbElkcyIsImlkIiwiaGFzaEtleSIsInBhcmVudEhhc2giLCJjaGlsZHJlbiIsIkFycmF5IiwiaXNBcnJheSIsIkRhdGFJbmRleCIsImRhdGEiLCJpbmRleEl0ZW0iLCJnZXRIYXNoIiwicGFyZW50SWRzIiwiY2FsbEJhY2siLCJzZXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTtBQUVBLElBQU1BLEtBQUssR0FBRyxJQUFJQyxPQUFKLEVBQWQ7O0FBRUEsU0FBU0MsY0FBVCxDQUF3QkMsR0FBeEIsRUFBNkI7QUFDM0IsU0FBT0EsR0FBRyxDQUFDQyxJQUFKLENBQVMsR0FBVCxDQUFQO0FBQ0Q7O0FBRUQsU0FBU0MsY0FBVCxDQUF3QkMsSUFBeEIsRUFBOEI7QUFDNUIsU0FBT0EsSUFBSSxHQUFHQSxJQUFJLENBQUNDLEtBQUwsQ0FBVyxHQUFYLENBQUgsR0FBcUIsRUFBaEM7QUFDRDs7QUFFRCxTQUFTQyxZQUFULENBQXNCQyxHQUF0QixFQUEyQk4sR0FBM0IsRUFBZ0M7QUFDOUIsTUFBTU8sU0FBUyxHQUFHVixLQUFLLENBQUNXLEdBQU4sQ0FBVUYsR0FBVixDQUFsQjtBQUNBLE1BQU1ILElBQUksR0FBR0osY0FBYyxDQUFD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L0IsQ0FBUjtBQUNELEtBSEQ7QUFJRCxHQWpDaUI7O0FBQ2hCLE1BQUlLLElBQUksWUFBWUQsU0FBcEIsRUFBK0I7QUFDN0J0QyxJQUFBQSxLQUFLLENBQUM0QyxHQUFOLENBQVUsSUFBVixFQUFnQkwsSUFBSSxDQUFDNUIsR0FBTCxFQUFoQjtBQUNELEdBRkQsTUFFTztBQUNMWCxJQUFBQSxLQUFLLENBQUM0QyxHQUFOLENBQVUsSUFBVixFQUFnQm5CLFdBQVcsQ0FBQ2MsSUFBRCxDQUEzQjtBQUNEO0FBQ0YsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIG5vLXBhcmFtLXJlYXNzaWduICovXG5cbmNvbnN0IGluZGV4ID0gbmV3IFdlYWtNYXAoKTtcblxuZnVuY3Rpb24gZ2V0SGFzaEZyb21JZHMoaWRzKSB7XG4gIHJldHVybiBpZHMuam9pbignXycpO1xufVxuXG5mdW5jdGlvbiBnZXRJZHNGcm9tSGFzaChoYXNoKSB7XG4gIHJldHVybiBoYXNoID8gaGFzaC5zcGxpdCgnXycpIDogW107XG59XG5cbmZ1bmN0aW9uIGdldEZyb21JbmRleChvYmosIGlkcykge1xuICBjb25zdCBkYXRhSW5kZXggPSBpbmRleC5nZXQob2JqKTtcbiAgY29uc3QgaGFzaCA9IGdldEhhc2hGcm9tSWRzKGlkcyk7XG4gIHJldHVybiBkYXRhSW5kZXhbaGFzaF0gPyBPYmplY3QuYXNzaWduKHt9LCBkYXRhSW5kZXhbaGFzaF0pIDogbnVsbDtcbn1cblxuZnVuY3Rpb24gZ2V0UGFyZW50cyhvYmosIGhhc2gsIHBhcmVudHMgPSBbXSkge1xuICBjb25zdCBpZHMgPSBnZXRJZHNGcm9tSGFzaChoYXNoKTtcbiAgaWYgKGlkcy5sZW5ndGggPiAxKSB7XG4gICAgaWRzLnBvcCgpO1xuICAgIGNvbnN0IG5ld0hhc2ggPSBnZXRIYXNoRnJvbUlkcyhpZHMpO1xuICAgIGNvbnN0IGRhdGFJbmRleCA9IGluZGV4LmdldChvYmopO1xuICAgIGlmIChkYXRhSW5kZXhbbmV3SGFzaF0gPT09IHVuZGVmaW5lZCkgdGhyb3cgbmV3IEVycm9yKGBIYXNoICcke25ld0hhc2h9JyBpcyBtaXNzZWQgZnJvbSBhbiBpbmRleGApO1xuICAgIHBhcmVudHMudW5zaGlmdChkYXRhSW5kZXhbbmV3SGFzaF0uaXRlbSk7XG4gICAgZ2V0UGFyZW50cyhvYmosIG5ld0hhc2gsIHBhcmVudHMpO1xuICB9XG4gIHJldHVybiBwYXJlbnRzO1xufVxuXG5mdW5jdGlvbiBhZGRJZFRvSGFzaChoYXNoLCBhZGRlZElkKSB7XG4gIGNvbnN0IGlkcyA9IGdldElkc0Zyb21IYXNoKGhhc2gpO1xuICByZXR1cm4gZ2V0SGFzaEZyb21JZHMoWy4uLmlkcywgYWRkZWRJZF0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVJbmRleChpdGVtcywgaW5kZXhSZXN1bHQgPSB7fSwgcGFyZW50cyA9IFtdKSB7XG4gIE9iamVjdC5rZXlzKGl0ZW1zKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICBjb25zdCBpdGVtID0gaXRlbXNba2V5XTtcbiAgICBjb25zdCBhbGxJZHMgPSBbLi4ucGFyZW50cywgaXRlbS5pZF07XG4gICAgY29uc3QgaGFzaEtleSA9IGdldEhhc2hGcm9tSWRzKGFsbElkcyk7XG4gICAgaW5kZXhSZXN1bHRbaGFzaEtleV0gPSB7XG4gICAgICBwYXJlbnRIYXNoOiBnZXRIYXNoRnJvbUlkcyhwYXJlbnRzKSxcbiAgICAgIGl0ZW0sXG4gICAgfTtcbiAgICBpZiAoaXRlbS5jaGlsZHJlbiAmJiBBcnJheS5pc0FycmF5KGl0ZW0uY2hpbGRyZW4pICYmIGl0ZW0uY2hpbGRyZW4ubGVuZ3RoID4gMCkge1xuICAgICAgY3JlYXRlSW5kZXgoaXRlbS5jaGlsZHJlbiwgaW5kZXhSZXN1bHQsIGFsbElkcyk7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gaW5kZXhSZXN1bHQ7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERhdGFJbmRleCB7XG4gIGNvbnN0cnVjdG9yKGRhdGEpIHtcbiAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIERhdGFJbmRleCkge1xuICAgICAgaW5kZXguc2V0KHRoaXMsIGRhdGEuZ2V0KCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpbmRleC5zZXQodGhpcywgY3JlYXRlSW5kZXgoZGF0YSkpO1xuICAgIH1cbiAgfVxuXG4gIGdldCA9ICgpID0+IE9iamVjdC5hc3NpZ24oe30sIGluZGV4LmdldCh0aGlzKSk7XG5cbiAgZ2V0SGFzaCA9IChpbmRleEl0ZW0pID0+IHtcbiAgICBpZiAoIWluZGV4SXRlbSkgdGhyb3cgbmV3IEVycm9yKCdEYXRhSW5kZXg6OmdldFBhcmVudHMoKTogdGhlcmUgaXMgbm8gaW5kZXhJdGVtJyk7XG4gICAgaWYgKCFpbmRleEl0ZW0uaXRlbSkgdGhyb3cgbmV3IEVycm9yKCdEYXRhSW5kZXg6OmdldFBhcmVudHMoKTogaXRlbSBpcyBub3QgZm91bmQgaW4gaW5kZXhJdGVtJyk7XG5cbiAgICByZXR1cm4gYWRkSWRUb0hhc2goaW5kZXhJdGVtLnBhcmVudEhhc2gsIGluZGV4SXRlbS5pdGVtLmlkKTtcbiAgfVxuXG4gIGdldEhhc2hGcm9tSWRzID0gaWRzID0+IGdldEhhc2hGcm9tSWRzKGlkcyk7XG5cbiAgZ2V0UGFyZW50c0J5SGFzaCA9IGhhc2ggPT4gZ2V0UGFyZW50cyh0aGlzLCBoYXNoKTtcblxuICBnZXRQYXJlbnRzID0gaW5kZXhJdGVtID0+IGdldFBhcmVudHModGhpcywgdGhpcy5nZXRIYXNoKGluZGV4SXRlbSkpO1xuXG4gIGdldEZyb21JbmRleCA9IChwYXJlbnRJZHMsIGlkKSA9PiBnZXRGcm9tSW5kZXgodGhpcywgWy4uLnBhcmVudElkcywgaWRdKVxuXG4gIGNsb25lID0gKCkgPT4gbmV3IERhdGFJbmRleCh0aGlzKTtcblxuICBmb3JFYWNoID0gKGNhbGxCYWNrKSA9PiB7XG4gICAgY29uc3QgZGF0YUluZGV4ID0gaW5kZXguZ2V0KHRoaXMpO1xuICAgIE9iamVjdC5rZXlzKGRhdGFJbmRleCkuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICBjb25zdCBpbmRleEl0ZW0gPSBkYXRhSW5kZXhba2V5XTtcbiAgICAgIGNhbGxCYWNrKGluZGV4SXRlbS5pdGVtLCBnZXRJZHNGcm9tSGFzaChpbmRleEl0ZW0ucGFyZW50SGFzaCkpO1xuICAgIH0pO1xuICB9XG59XG4iXX0=