"use strict";

exports.__esModule = true;
exports["default"] = void 0;

var _base = _interopRequireDefault(require("../base"));

var _checkedHashItem = _interopRequireDefault(require("./checked-hash-item"));

var _checkedOutput = _interopRequireDefault(require("./checked-output"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var sourceProvider = new WeakMap();
var providerId = new WeakMap();
var checked = new WeakMap();
var index = new WeakMap();
var lastUpdate = new WeakMap();

function clearAll(list) {
  checked.set(list, {});
}

function getChildHashesOfCheckedItems(list, hash) {
  var checkedItems = checked.get(list);
  var hashes = [];
  Object.keys(checkedItems).forEach(function (currentHash) {
    if (hash !== currentHash && currentHash.indexOf(hash) === 0) {
      hashes.push(currentHash);
    }
  });
  return hashes;
}

function removeItem(list, parentIds, id) {
  var checkedItems = checked.get(list);
  var dataIndex = index.get(list);
  var indexItem = dataIndex.getFromIndex(parentIds, id);

  if (indexItem) {
    var parentHash = indexItem.parentHash;

    if (checkedItems[parentHash]) {
      checkedItems[parentHash].removeCheckedItem(indexItem.item); // Checks if there is no checked items, then removes a hash

      if (checkedItems[parentHash].getCheckedItems().length === 0) {
        delete checkedItems[parentHash];
      }
    }
  }
}

function removeHash(list, hash) {
  var checkedItems = checked.get(list);

  if (checkedItems[hash]) {
    checkedItems[hash].uncheckAll();
    delete checkedItems[hash];
  }
}

function removeAllItems(list, parentIds, id) {
  var dataIndex = index.get(list);
  var indexItem = dataIndex.getFromIndex(parentIds, id);

  if (indexItem) {
    var hash = dataIndex.getHash(indexItem);
    removeHash(list, hash);
  }
}

function addItem(list, parentIds, id) {
  var checkedItems = checked.get(list);
  var dataIndex = index.get(list);
  var indexItem = dataIndex.getFromIndex(parentIds, id);

  if (indexItem) {
    var parentHash = indexItem.parentHash;
    var parents = dataIndex.getParents(indexItem);
    if (!checkedItems[parentHash]) checkedItems[parentHash] = new _checkedHashItem["default"](parents);
    var hashItem = checkedItems[parentHash];
    hashItem.addCheckedItem(indexItem.item);
  }
}

function addAllItems(list, parentIds, id) {
  var checkedItems = checked.get(list);
  var dataIndex = index.get(list);
  var indexItem = dataIndex.getFromIndex(parentIds, id);

  if (indexItem) {
    var hash = dataIndex.getHash(indexItem);
    var parents = [].concat(dataIndex.getParents(indexItem), [indexItem.item]);
    var childHashes = getChildHashesOfCheckedItems(list, hash) || [];
    childHashes.forEach(function (h) {
      removeHash(list, h);
    });
    if (!checkedItems[hash]) checkedItems[hash] = new _checkedHashItem["default"](parents);
    var hashItem = checkedItems[hash];
    hashItem.checkAll();
  }
}

function preCheckItems(list, preCheckedItems) {
  var dataIndex = index.get(list);

  var getHash = function getHash(parentId, id) {
    return parentId ? parentId + "_" + id : "" + id;
  };

  clearAll(list);

  if (dataIndex && preCheckedItems) {
    // creating a hash for pre-checked items to increase speed of searching
    var hashOfPreChecked = [];
    preCheckedItems.forEach(function (i) {
      var hs = getHash(i.parentId, i.id);
      hashOfPreChecked[hs] = i;
    });
    dataIndex.forEach(function (item, parentIds) {
      var hs = getHash(parentIds.length > 0 ? parentIds[parentIds.length - 1] : null, item.id);
      var found = hashOfPreChecked[hs];

      if (found) {
        if (found.isCheckedAll && Array.isArray(item.children) && item.children.length > 0) {
          addAllItems(list, parentIds, item.id);
        } else {
          addItem(list, parentIds, item.id);
        }
      }
    });
  }
}

function afterUpdate(list) {
  lastUpdate.set(list, Date.now());
}

var CheckedItemHashList =
/*#__PURE__*/
function (_BaseModel) {
  _inheritsLoose(CheckedItemHashList, _BaseModel);

  function CheckedItemHashList(dataSourceProvider) {
    var _this;

    _this = _BaseModel.call(this, dataSourceProvider) || this;

    _defineProperty(_assertThisInitialized(_this), "get", function () {
      return checked.get(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "getAllCheckedItems", function () {
      var checkedHashArray = checked.get(_assertThisInitialized(_this));
      var list = [];
      Object.keys(checkedHashArray).forEach(function (key) {
        list = list.concat(checkedHashArray[key].getCheckedItems());
      });
      return list;
    });

    _defineProperty(_assertThisInitialized(_this), "getCheckedItems", function (parentIds) {
      if (parentIds === void 0) {
        parentIds = [];
      }

      var checkedHashItem = _this.getHashItem(parentIds);

      var result = [];

      if (checkedHashItem) {
        result = checkedHashItem.getCheckedItems();
      }

      return result;
    });

    _defineProperty(_assertThisInitialized(_this), "getIsCheckedAll", function (parentIds) {
      if (parentIds === void 0) {
        parentIds = [];
      }

      var checkedHashItem = _this.getHashItem(parentIds);

      return checkedHashItem ? checkedHashItem.isCheckedAll() : false;
    });

    _defineProperty(_assertThisInitialized(_this), "getCheckedItemsCount", function () {
      var checkedHashArray = checked.get(_assertThisInitialized(_this));
      var count = 0;
      Object.keys(checkedHashArray).forEach(function (key) {
        count += checkedHashArray[key].getCheckedItems().length;
      });
      return count;
    });

    _defineProperty(_assertThisInitialized(_this), "getId", function () {
      return providerId.get(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "getHashItem", function (parentIds) {
      if (parentIds === void 0) {
        parentIds = [];
      }

      var checkedHashArray = checked.get(_assertThisInitialized(_this));
      var dataIndex = index.get(_assertThisInitialized(_this));
      var hash = dataIndex.getHashFromIds(parentIds);

      if (hash === '' || !checkedHashArray[hash]) {
        return null;
      }

      return checkedHashArray[hash];
    });

    _defineProperty(_assertThisInitialized(_this), "getLastUpdateStamp", function () {
      return lastUpdate.get(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "getCheckedOutput", function () {
      var resultObject = {
        dataSourceProviderId: _this.getId(),
        checked: []
      };
      var checkedOutput = new _checkedOutput["default"]();
      var hashes = checked.get(_assertThisInitialized(_this));
      Object.keys(hashes).forEach(function (hash) {
        var checkedHashItem = hashes[hash];
        checkedOutput.add(checkedHashItem);
      });
      resultObject.checked = checkedOutput.get();
      return resultObject;
    });

    _defineProperty(_assertThisInitialized(_this), "add", function (parentIds, id) {
      addItem(_assertThisInitialized(_this), parentIds, id);
      afterUpdate(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "addAll", function (parentIds, id) {
      addAllItems(_assertThisInitialized(_this), parentIds, id);
      afterUpdate(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "createCopy", function () {
      var copy = new CheckedItemHashList(sourceProvider.get(_assertThisInitialized(_this)));
      providerId.set(copy, providerId.get(_assertThisInitialized(_this)));
      lastUpdate.set(copy, lastUpdate.get(_assertThisInitialized(_this)));
      index.set(copy, index.get(_assertThisInitialized(_this)).clone());
      var chkd = Object.assign({}, checked.get(_assertThisInitialized(_this)));
      Object.keys(chkd).forEach(function (key) {
        chkd[key] = chkd[key].createCopy();
      });
      checked.set(copy, chkd);
      return copy;
    });

    _defineProperty(_assertThisInitialized(_this), "clearAll", function () {
      clearAll(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "preCheckItems", function (preCheckedItems) {
      preCheckItems(_assertThisInitialized(_this), preCheckedItems);
      afterUpdate(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "remove", function (parentIds, id) {
      removeItem(_assertThisInitialized(_this), parentIds, id);
      afterUpdate(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "removeAll", function (parentIds, id) {
      removeAllItems(_assertThisInitialized(_this), parentIds, id);
      afterUpdate(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "removeHash", function (hash) {
      removeHash(_assertThisInitialized(_this), hash);
      afterUpdate(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "toString", function () {
      var list = checked.get(_assertThisInitialized(_this));
      var result = {};
      Object.keys(list).forEach(function (key) {
        var item = list[key];
        result[key] = {
          checkedAll: item.isCheckedAll(),
          checkedItems: item.getCheckedItems()
        };
      });
      return JSON.stringify({
        id: _this.getId(),
        lastUpdateStamp: _this.getLastUpdateStamp(),
        checked: result
      }, null, 2);
    });

    sourceProvider.set(_assertThisInitialized(_this), dataSourceProvider);
    providerId.set(_assertThisInitialized(_this), dataSourceProvider.id);
    lastUpdate.set(_assertThisInitialized(_this), 0);
    checked.set(_assertThisInitialized(_this), {});
    index.set(_assertThisInitialized(_this), dataSourceProvider.getIndex());
    return _this;
  }

  return CheckedItemHashList;
}(_base["default"]);

var _default = CheckedItemHashList;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tb2RlbHMvY2hlY2tlZC1pdGVtcy9jaGVja2VkLWl0ZW0taGFzaC1saXN0LmpzIl0sIm5hbWVzIjpbInNvdXJjZVByb3ZpZGVyIiwiV2Vha01hcCIsInByb3ZpZGVySWQiLCJjaGVja2VkIiwiaW5kZXgiLCJsYXN0VXBkYXRlIiwiY2xlYXJBbGwiLCJsaXN0Iiwic2V0IiwiZ2V0Q2hpbGRIYXNoZXNPZkNoZWNrZWRJdGVtcyIsImhhc2giLCJjaGVja2VkSXRlbXMiLCJnZXQiLCJoYXNoZXMiLCJPYmplY3QiLCJrZXlzIiwiZm9yRWFjaCIsImN1cnJlbnRIYXNoIiwiaW5kZXhPZiIsInB1c2giLCJyZW1vdmVJdGVtIiwicGFyZW50SWRzIiwiaWQiLCJkYXRhSW5kZXgiLCJpbmRleEl0ZW0iLCJnZXRGcm9tSW5kZXgiLCJwYXJlbnRIYXNoIiwicmVtb3ZlQ2hlY2tlZEl0ZW0iLCJpdGVtIiwiZ2V0Q2hlY2tlZEl0ZW1zIiwibGVuZ3RoIiwicmVtb3ZlSGFzaCIsInVuY2hlY2tBbGwiLCJyZW1vdmVBbGxJdGVtcyIsImdldEhhc2giLCJhZGRJdGVtIiwicGFyZW50cyIsImdldFBhcmVudHMiLCJDaGVja2VkSGFzaEl0ZW0iLCJoYXNoSXRlbSIsImFkZENoZWNrZWRJdGVtIiwiYWRkQWxsSXRlbXMiLCJjaGlsZEhhc2hlcyIsImgiLCJjaGVja0FsbCIsInByZUNoZWNrSXRlbXMiLCJwcmVDaGVja2VkSXRlbXMiLCJwYXJlbnRJZCIsImhhc2hPZlByZUNoZWNrZWQiLCJpIiwiaHMiLCJmb3VuZCIsImlzQ2hlY2tlZEFsbCIsIkFycmF5IiwiaXNBcnJheSIsImNoaWxkcmVuIiwiYWZ0ZXJVcGRhdGUiLCJEYXRlIiwibm93IiwiQ2hlY2tlZEl0ZW1IYXNoTGlzdCIsImRhdGFTb3VyY2VQcm92aWRlciIsImNoZWNrZWRIYXNoQXJyYXkiLCJrZXkiLCJjb25jYXQiLCJjaGVja2VkSGFzaEl0ZW0iLCJnZXRIYXNoSXRlbSIsInJlc3VsdCIsImNvdW50IiwiZ2V0SGFzaEZyb21JZHMiLCJyZXN1bHRPYmplY3QiLCJkYXRhU291cmNlUHJvdmlkZXJJZCIsImdldElkIiwiY2hlY2tlZE91dHB1dCIsIkNoZWNrZWRPdXRwdXQiLCJhZGQiLCJjb3B5IiwiY2xvbmUiLCJjaGtkIiwiYXNzaWduIiwiY3JlYXRlQ29weSIsImNoZWNrZWRBbGwiLCJKU09OIiwic3RyaW5naWZ5IiwibGFzdFVwZGF0ZVN0YW1wIiwiZ2V0TGFzdFVwZGF0ZVN0YW1wIiwiZ2V0SW5kZXgiLCJCYXNlTW9kZWwiXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7QUFFQSxJQUFNQSxjQUFjLEdBQUcsSUFBSUMsT0FBSixFQUF2QjtBQUNBLElBQU1DLFVBQVUsR0FBRyxJQUFJRCxPQUFKLEVBQW5CO0FBQ0EsSUFBTUUsT0FBTyxHQUFHLElBQUlGLE9BQUosRUFBaEI7QUFDQSxJQUFNRyxLQUFLLEdBQUcsSUFBSUgsT0FBSixFQUFkO0FBQ0EsSUFBTUksVUFBVSxHQUFHLElBQUlKLE9BQUosRUFBbkI7O0FBRUEsU0FBU0ssUUFBVCxDQUFrQkMsSUFBbEIsRUFBd0I7QUFDdEJKLEVBQUFBLE9BQU8sQ0FBQ0ssR0FBUixDQUFZRCxJQUFaLEVBQWtCLEVBQWxCO0FBQ0Q7O0FBRUQsU0FBU0UsNEJBQVQsQ0FBc0NGLElBQXRDLEVBQTRDRyxJQUE1QyxFQUFrRDtBQUNoRCxNQUFNQyxZQUFZLEdBQUdSLE9BQU8sQ0FBQ1MsR0FBUixDQUFZTCxJQUFaLENBQXJCO0FBQ0EsTUFBTU0sTUFBTSxHQUFHLEVBQWY7QUFDQUMsRUFBQUEsTUFBTSxDQUFDQyxJQUFQLENBQVlKLFlBQVosRUFBMEJLLE9BQTFCLENBQWtDLFVBQUNDLFdBQUQsRUFBaUI7QUFDakQsUUFBSVAsSUFBSSxLQUFLTyxXQUFULElBQXdCQSxXQUFXLENBQUNDLE9BQVosQ0FBb0JSLElBQXBCLE1BQThCLENBQTFELEVBQTZEO0FBQzNERyxNQUFBQSxNQUFNLENBQUNNLElBQVAsQ0FBWUYsV0FB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QSxLQUFLLENBQUNJLEdBQU4sZ0NBQWdCb0Qsa0JBQWtCLENBQUN5QixRQUFuQixFQUFoQjtBQU44QjtBQU8vQjs7O0VBUitCQyxnQjs7ZUErSW5CM0IsbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQmFzZU1vZGVsIGZyb20gJy4uL2Jhc2UnO1xuaW1wb3J0IENoZWNrZWRIYXNoSXRlbSBmcm9tICcuL2NoZWNrZWQtaGFzaC1pdGVtJztcbmltcG9ydCBDaGVja2VkT3V0cHV0IGZyb20gJy4vY2hlY2tlZC1vdXRwdXQnO1xuXG5jb25zdCBzb3VyY2VQcm92aWRlciA9IG5ldyBXZWFrTWFwKCk7XG5jb25zdCBwcm92aWRlcklkID0gbmV3IFdlYWtNYXAoKTtcbmNvbnN0IGNoZWNrZWQgPSBuZXcgV2Vha01hcCgpO1xuY29uc3QgaW5kZXggPSBuZXcgV2Vha01hcCgpO1xuY29uc3QgbGFzdFVwZGF0ZSA9IG5ldyBXZWFrTWFwKCk7XG5cbmZ1bmN0aW9uIGNsZWFyQWxsKGxpc3QpIHtcbiAgY2hlY2tlZC5zZXQobGlzdCwge30pO1xufVxuXG5mdW5jdGlvbiBnZXRDaGlsZEhhc2hlc09mQ2hlY2tlZEl0ZW1zKGxpc3QsIGhhc2gpIHtcbiAgY29uc3QgY2hlY2tlZEl0ZW1zID0gY2hlY2tlZC5nZXQobGlzdCk7XG4gIGNvbnN0IGhhc2hlcyA9IFtdO1xuICBPYmplY3Qua2V5cyhjaGVja2VkSXRlbXMpLmZvckVhY2goKGN1cnJlbnRIYXNoKSA9PiB7XG4gICAgaWYgKGhhc2ggIT09IGN1cnJlbnRIYXNoICYmIGN1cnJlbnRIYXNoLmluZGV4T2YoaGFzaCkgPT09IDApIHtcbiAgICAgIGhhc2hlcy5wdXNoKGN1cnJlbnRIYXNoKTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBoYXNoZXM7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUl0ZW0obGlzdCwgcGFyZW50SWRzLCBpZCkge1xuICBjb25zdCBjaGVja2VkSXRlbXMgPSBjaGVja2VkLmdldChsaXN0KTtcbiAgY29uc3QgZGF0YUluZGV4ID0gaW5kZXguZ2V0KGxpc3QpO1xuICBjb25zdCBpbmRleEl0ZW0gPSBkYXRhSW5kZXguZ2V0RnJvbUluZGV4KHBhcmVudElkcywgaWQpO1xuXG4gIGlmIChpbmRleEl0ZW0pIHtcbiAgICBjb25zdCB7IHBhcmVudEhhc2ggfSA9IGluZGV4SXRlbTtcblxuICAgIGlmIChjaGVja2VkSXRlbXNbcGFyZW50SGFzaF0pIHtcbiAgICAgIGNoZWNrZWRJdGVtc1twYXJlbnRIYXNoXS5yZW1vdmVDaGVja2VkSXRlbShpbmRleEl0ZW0uaXRlbSk7XG4gICAgICAvLyBDaGVja3MgaWYgdGhlcmUgaXMgbm8gY2hlY2tlZCBpdGVtcywgdGhlbiByZW1vdmVzIGEgaGFzaFxuICAgICAgaWYgKGNoZWNrZWRJdGVtc1twYXJlbnRIYXNoXS5nZXRDaGVja2VkSXRlbXMoKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgZGVsZXRlIGNoZWNrZWRJdGVtc1twYXJlbnRIYXNoXTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVtb3ZlSGFzaChsaXN0LCBoYXNoKSB7XG4gIGNvbnN0IGNoZWNrZWRJdGVtcyA9IGNoZWNrZWQuZ2V0KGxpc3QpO1xuICBpZiAoY2hlY2tlZEl0ZW1zW2hhc2hdKSB7XG4gICAgY2hlY2tlZEl0ZW1zW2hhc2hdLnVuY2hlY2tBbGwoKTtcbiAgICBkZWxldGUgY2hlY2tlZEl0ZW1zW2hhc2hdO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUFsbEl0ZW1zKGxpc3QsIHBhcmVudElkcywgaWQpIHtcbiAgY29uc3QgZGF0YUluZGV4ID0gaW5kZXguZ2V0KGxpc3QpO1xuICBjb25zdCBpbmRleEl0ZW0gPSBkYXRhSW5kZXguZ2V0RnJvbUluZGV4KHBhcmVudElkcywgaWQpO1xuXG4gIGlmIChpbmRleEl0ZW0pIHtcbiAgICBjb25zdCBoYXNoID0gZGF0YUluZGV4LmdldEhhc2goaW5kZXhJdGVtKTtcbiAgICByZW1vdmVIYXNoKGxpc3QsIGhhc2gpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGFkZEl0ZW0obGlzdCwgcGFyZW50SWRzLCBpZCkge1xuICBjb25zdCBjaGVja2VkSXRlbXMgPSBjaGVja2VkLmdldChsaXN0KTtcbiAgY29uc3QgZGF0YUluZGV4ID0gaW5kZXguZ2V0KGxpc3QpO1xuICBjb25zdCBpbmRleEl0ZW0gPSBkYXRhSW5kZXguZ2V0RnJvbUluZGV4KHBhcmVudElkcywgaWQpO1xuXG4gIGlmIChpbmRleEl0ZW0pIHtcbiAgICBjb25zdCB7IHBhcmVudEhhc2ggfSA9IGluZGV4SXRlbTtcbiAgICBjb25zdCBwYXJlbnRzID0gZGF0YUluZGV4LmdldFBhcmVudHMoaW5kZXhJdGVtKTtcblxuICAgIGlmICghY2hlY2tlZEl0ZW1zW3BhcmVudEhhc2hdKSBjaGVja2VkSXRlbXNbcGFyZW50SGFzaF0gPSBuZXcgQ2hlY2tlZEhhc2hJdGVtKHBhcmVudHMpO1xuXG4gICAgY29uc3QgaGFzaEl0ZW0gPSBjaGVja2VkSXRlbXNbcGFyZW50SGFzaF07XG4gICAgaGFzaEl0ZW0uYWRkQ2hlY2tlZEl0ZW0oaW5kZXhJdGVtLml0ZW0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIGFkZEFsbEl0ZW1zKGxpc3QsIHBhcmVudElkcywgaWQpIHtcbiAgY29uc3QgY2hlY2tlZEl0ZW1zID0gY2hlY2tlZC5nZXQobGlzdCk7XG4gIGNvbnN0IGRhdGFJbmRleCA9IGluZGV4LmdldChsaXN0KTtcbiAgY29uc3QgaW5kZXhJdGVtID0gZGF0YUluZGV4LmdldEZyb21JbmRleChwYXJlbnRJZHMsIGlkKTtcbiAgaWYgKGluZGV4SXRlbSkge1xuICAgIGNvbnN0IGhhc2ggPSBkYXRhSW5kZXguZ2V0SGFzaChpbmRleEl0ZW0pO1xuICAgIGNvbnN0IHBhcmVudHMgPSBbLi4uZGF0YUluZGV4LmdldFBhcmVudHMoaW5kZXhJdGVtKSwgaW5kZXhJdGVtLml0ZW1dO1xuICAgIGNvbnN0IGNoaWxkSGFzaGVzID0gZ2V0Q2hpbGRIYXNoZXNPZkNoZWNrZWRJdGVtcyhsaXN0LCBoYXNoKSB8fCBbXTtcblxuICAgIGNoaWxkSGFzaGVzLmZvckVhY2goKGgpID0+IHsgcmVtb3ZlSGFzaChsaXN0LCBoKTsgfSk7XG5cbiAgICBpZiAoIWNoZWNrZWRJdGVtc1toYXNoXSkgY2hlY2tlZEl0ZW1zW2hhc2hdID0gbmV3IENoZWNrZWRIYXNoSXRlbShwYXJlbnRzKTtcblxuICAgIGNvbnN0IGhhc2hJdGVtID0gY2hlY2tlZEl0ZW1zW2hhc2hdO1xuICAgIGhhc2hJdGVtLmNoZWNrQWxsKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gcHJlQ2hlY2tJdGVtcyhsaXN0LCBwcmVDaGVja2VkSXRlbXMpIHtcbiAgY29uc3QgZGF0YUluZGV4ID0gaW5kZXguZ2V0KGxpc3QpO1xuICBjb25zdCBnZXRIYXNoID0gKHBhcmVudElkLCBpZCkgPT4gKFxuICAgIHBhcmVudElkID8gYCR7cGFyZW50SWR9XyR7aWR9YCA6IGAke2lkfWBcbiAgKTtcbiAgY2xlYXJBbGwobGlzdCk7XG5cbiAgaWYgKGRhdGFJbmRleCAmJiBwcmVDaGVja2VkSXRlbXMpIHtcbiAgICAvLyBjcmVhdGluZyBhIGhhc2ggZm9yIHByZS1jaGVja2VkIGl0ZW1zIHRvIGluY3JlYXNlIHNwZWVkIG9mIHNlYXJjaGluZ1xuICAgIGNvbnN0IGhhc2hPZlByZUNoZWNrZWQgPSBbXTtcbiAgICBwcmVDaGVja2VkSXRlbXMuZm9yRWFjaCgoaSkgPT4ge1xuICAgICAgY29uc3QgaHMgPSBnZXRIYXNoKGkucGFyZW50SWQsIGkuaWQpO1xuICAgICAgaGFzaE9mUHJlQ2hlY2tlZFtoc10gPSBpO1xuICAgIH0pO1xuXG4gICAgZGF0YUluZGV4LmZvckVhY2goKGl0ZW0sIHBhcmVudElkcykgPT4ge1xuICAgICAgY29uc3QgaHMgPSBnZXRIYXNoKHBhcmVudElkcy5sZW5ndGggPiAwID8gcGFyZW50SWRzW3BhcmVudElkcy5sZW5ndGggLSAxXSA6IG51bGwsIGl0ZW0uaWQpO1xuICAgICAgY29uc3QgZm91bmQgPSBoYXNoT2ZQcmVDaGVja2VkW2hzXTtcbiAgICAgIGlmIChmb3VuZCkge1xuICAgICAgICBpZiAoZm91bmQuaXNDaGVja2VkQWxsICYmIEFycmF5LmlzQXJyYXkoaXRlbS5jaGlsZHJlbikgJiYgaXRlbS5jaGlsZHJlbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgYWRkQWxsSXRlbXMobGlzdCwgcGFyZW50SWRzLCBpdGVtLmlkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBhZGRJdGVtKGxpc3QsIHBhcmVudElkcywgaXRlbS5pZCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhZnRlclVwZGF0ZShsaXN0KSB7XG4gIGxhc3RVcGRhdGUuc2V0KGxpc3QsIERhdGUubm93KCkpO1xufVxuXG5jbGFzcyBDaGVja2VkSXRlbUhhc2hMaXN0IGV4dGVuZHMgQmFzZU1vZGVsIHtcbiAgY29uc3RydWN0b3IoZGF0YVNvdXJjZVByb3ZpZGVyKSB7XG4gICAgc3VwZXIoZGF0YVNvdXJjZVByb3ZpZGVyKTtcbiAgICBzb3VyY2VQcm92aWRlci5zZXQodGhpcywgZGF0YVNvdXJjZVByb3ZpZGVyKTtcbiAgICBwcm92aWRlcklkLnNldCh0aGlzLCBkYXRhU291cmNlUHJvdmlkZXIuaWQpO1xuICAgIGxhc3RVcGRhdGUuc2V0KHRoaXMsIDApO1xuICAgIGNoZWNrZWQuc2V0KHRoaXMsIHt9KTtcbiAgICBpbmRleC5zZXQodGhpcywgZGF0YVNvdXJjZVByb3ZpZGVyLmdldEluZGV4KCkpO1xuICB9XG5cbiAgZ2V0ID0gKCkgPT4gY2hlY2tlZC5nZXQodGhpcyk7XG5cbiAgZ2V0QWxsQ2hlY2tlZEl0ZW1zID0gKCkgPT4ge1xuICAgIGNvbnN0IGNoZWNrZWRIYXNoQXJyYXkgPSBjaGVja2VkLmdldCh0aGlzKTtcbiAgICBsZXQgbGlzdCA9IFtdO1xuICAgIE9iamVjdC5rZXlzKGNoZWNrZWRIYXNoQXJyYXkpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgbGlzdCA9IGxpc3QuY29uY2F0KGNoZWNrZWRIYXNoQXJyYXlba2V5XS5nZXRDaGVja2VkSXRlbXMoKSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGxpc3Q7XG4gIH1cblxuICBnZXRDaGVja2VkSXRlbXMgPSAocGFyZW50SWRzID0gW10pID0+IHtcbiAgICBjb25zdCBjaGVja2VkSGFzaEl0ZW0gPSB0aGlzLmdldEhhc2hJdGVtKHBhcmVudElkcyk7XG4gICAgbGV0IHJlc3VsdCA9IFtdO1xuICAgIGlmIChjaGVja2VkSGFzaEl0ZW0pIHtcbiAgICAgIHJlc3VsdCA9IGNoZWNrZWRIYXNoSXRlbS5nZXRDaGVja2VkSXRlbXMoKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGdldElzQ2hlY2tlZEFsbCA9IChwYXJlbnRJZHMgPSBbXSkgPT4ge1xuICAgIGNvbnN0IGNoZWNrZWRIYXNoSXRlbSA9IHRoaXMuZ2V0SGFzaEl0ZW0ocGFyZW50SWRzKTtcbiAgICByZXR1cm4gY2hlY2tlZEhhc2hJdGVtID8gY2hlY2tlZEhhc2hJdGVtLmlzQ2hlY2tlZEFsbCgpIDogZmFsc2U7XG4gIH1cblxuICBnZXRDaGVja2VkSXRlbXNDb3VudCA9ICgpID0+IHtcbiAgICBjb25zdCBjaGVja2VkSGFzaEFycmF5ID0gY2hlY2tlZC5nZXQodGhpcyk7XG4gICAgbGV0IGNvdW50ID0gMDtcbiAgICBPYmplY3Qua2V5cyhjaGVja2VkSGFzaEFycmF5KS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIGNvdW50ICs9IGNoZWNrZWRIYXNoQXJyYXlba2V5XS5nZXRDaGVja2VkSXRlbXMoKS5sZW5ndGg7XG4gICAgfSk7XG4gICAgcmV0dXJuIGNvdW50O1xuICB9XG5cbiAgZ2V0SWQgPSAoKSA9PiBwcm92aWRlcklkLmdldCh0aGlzKTtcblxuICBnZXRIYXNoSXRlbSA9IChwYXJlbnRJZHMgPSBbXSkgPT4ge1xuICAgIGNvbnN0IGNoZWNrZWRIYXNoQXJyYXkgPSBjaGVja2VkLmdldCh0aGlzKTtcbiAgICBjb25zdCBkYXRhSW5kZXggPSBpbmRleC5nZXQodGhpcyk7XG4gICAgY29uc3QgaGFzaCA9IGRhdGFJbmRleC5nZXRIYXNoRnJvbUlkcyhwYXJlbnRJZHMpO1xuXG4gICAgaWYgKGhhc2ggPT09ICcnIHx8ICFjaGVja2VkSGFzaEFycmF5W2hhc2hdKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIGNoZWNrZWRIYXNoQXJyYXlbaGFzaF07XG4gIH07XG5cbiAgZ2V0TGFzdFVwZGF0ZVN0YW1wID0gKCkgPT4gbGFzdFVwZGF0ZS5nZXQodGhpcyk7XG5cbiAgZ2V0Q2hlY2tlZE91dHB1dCA9ICgpID0+IHtcbiAgICBjb25zdCByZXN1bHRPYmplY3QgPSB7XG4gICAgICBkYXRhU291cmNlUHJvdmlkZXJJZDogdGhpcy5nZXRJZCgpLFxuICAgICAgY2hlY2tlZDogW10sXG4gICAgfTtcbiAgICBjb25zdCBjaGVja2VkT3V0cHV0ID0gbmV3IENoZWNrZWRPdXRwdXQoKTtcbiAgICBjb25zdCBoYXNoZXMgPSBjaGVja2VkLmdldCh0aGlzKTtcblxuICAgIE9iamVjdC5rZXlzKGhhc2hlcykuZm9yRWFjaCgoaGFzaCkgPT4ge1xuICAgICAgY29uc3QgY2hlY2tlZEhhc2hJdGVtID0gaGFzaGVzW2hhc2hdO1xuICAgICAgY2hlY2tlZE91dHB1dC5hZGQoY2hlY2tlZEhhc2hJdGVtKTtcbiAgICB9KTtcblxuICAgIHJlc3VsdE9iamVjdC5jaGVja2VkID0gY2hlY2tlZE91dHB1dC5nZXQoKTtcblxuICAgIHJldHVybiByZXN1bHRPYmplY3Q7XG4gIH1cblxuICBhZGQgPSAocGFyZW50SWRzLCBpZCkgPT4ge1xuICAgIGFkZEl0ZW0odGhpcywgcGFyZW50SWRzLCBpZCk7XG4gICAgYWZ0ZXJVcGRhdGUodGhpcyk7XG4gIH1cblxuICBhZGRBbGwgPSAocGFyZW50SWRzLCBpZCkgPT4ge1xuICAgIGFkZEFsbEl0ZW1zKHRoaXMsIHBhcmVudElkcywgaWQpO1xuICAgIGFmdGVyVXBkYXRlKHRoaXMpO1xuICB9XG5cbiAgY3JlYXRlQ29weSA9ICgpID0+IHtcbiAgICBjb25zdCBjb3B5ID0gbmV3IENoZWNrZWRJdGVtSGFzaExpc3Qoc291cmNlUHJvdmlkZXIuZ2V0KHRoaXMpKTtcblxuICAgIHByb3ZpZGVySWQuc2V0KGNvcHksIHByb3ZpZGVySWQuZ2V0KHRoaXMpKTtcbiAgICBsYXN0VXBkYXRlLnNldChjb3B5LCBsYXN0VXBkYXRlLmdldCh0aGlzKSk7XG4gICAgaW5kZXguc2V0KGNvcHksIGluZGV4LmdldCh0aGlzKS5jbG9uZSgpKTtcblxuICAgIGNvbnN0IGNoa2QgPSBPYmplY3QuYXNzaWduKHt9LCBjaGVja2VkLmdldCh0aGlzKSk7XG4gICAgT2JqZWN0LmtleXMoY2hrZCkuZm9yRWFjaCgoa2V5KSA9PiB7IGNoa2Rba2V5XSA9IGNoa2Rba2V5XS5jcmVhdGVDb3B5KCk7IH0pO1xuICAgIGNoZWNrZWQuc2V0KGNvcHksIGNoa2QpO1xuXG4gICAgcmV0dXJuIGNvcHk7XG4gIH1cblxuICBjbGVhckFsbCA9ICgpID0+IHtcbiAgICBjbGVhckFsbCh0aGlzKTtcbiAgfVxuXG4gIHByZUNoZWNrSXRlbXMgPSAocHJlQ2hlY2tlZEl0ZW1zKSA9PiB7XG4gICAgcHJlQ2hlY2tJdGVtcyh0aGlzLCBwcmVDaGVja2VkSXRlbXMpO1xuICAgIGFmdGVyVXBkYXRlKHRoaXMpO1xuICB9XG5cbiAgcmVtb3ZlID0gKHBhcmVudElkcywgaWQpID0+IHtcbiAgICByZW1vdmVJdGVtKHRoaXMsIHBhcmVudElkcywgaWQpO1xuICAgIGFmdGVyVXBkYXRlKHRoaXMpO1xuICB9XG5cbiAgcmVtb3ZlQWxsID0gKHBhcmVudElkcywgaWQpID0+IHtcbiAgICByZW1vdmVBbGxJdGVtcyh0aGlzLCBwYXJlbnRJZHMsIGlkKTtcbiAgICBhZnRlclVwZGF0ZSh0aGlzKTtcbiAgfVxuXG4gIHJlbW92ZUhhc2ggPSAoaGFzaCkgPT4ge1xuICAgIHJlbW92ZUhhc2godGhpcywgaGFzaCk7XG4gICAgYWZ0ZXJVcGRhdGUodGhpcyk7XG4gIH1cblxuICB0b1N0cmluZyA9ICgpID0+IHtcbiAgICBjb25zdCBsaXN0ID0gY2hlY2tlZC5nZXQodGhpcyk7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgT2JqZWN0LmtleXMobGlzdCkuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICBjb25zdCBpdGVtID0gbGlzdFtrZXldO1xuICAgICAgcmVzdWx0W2tleV0gPSB7XG4gICAgICAgIGNoZWNrZWRBbGw6IGl0ZW0uaXNDaGVja2VkQWxsKCksXG4gICAgICAgIGNoZWNrZWRJdGVtczogaXRlbS5nZXRDaGVja2VkSXRlbXMoKSxcbiAgICAgIH07XG4gICAgfSk7XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIGlkOiB0aGlzLmdldElkKCksXG4gICAgICBsYXN0VXBkYXRlU3RhbXA6IHRoaXMuZ2V0TGFzdFVwZGF0ZVN0YW1wKCksXG4gICAgICBjaGVja2VkOiByZXN1bHQsXG4gICAgfSwgbnVsbCwgMik7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQ2hlY2tlZEl0ZW1IYXNoTGlzdDtcbiJdfQ==