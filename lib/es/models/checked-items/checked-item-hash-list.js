function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

import BaseModel from '../base';
import CheckedHashItem from './checked-hash-item';
import CheckedOutput from './checked-output';
var sourceProvider = new WeakMap();
var providerId = new WeakMap();
var checked = new WeakMap();
var index = new WeakMap();
var lastUpdate = new WeakMap();

function clearAll(list) {
  checked.set(list, {});
}

function getChildHashesOfCheckedItems(list, hash) {
  var checkedItems = checked.get(list);
  var hashes = [];
  Object.keys(checkedItems).forEach(function (currentHash) {
    if (hash !== currentHash && currentHash.indexOf(hash) === 0) {
      hashes.push(currentHash);
    }
  });
  return hashes;
}

function removeItem(list, parentIds, id) {
  var checkedItems = checked.get(list);
  var dataIndex = index.get(list);
  var indexItem = dataIndex.getFromIndex(parentIds, id);

  if (indexItem) {
    var parentHash = indexItem.parentHash;

    if (checkedItems[parentHash]) {
      checkedItems[parentHash].removeCheckedItem(indexItem.item); // Checks if there is no checked items, then removes a hash

      if (checkedItems[parentHash].getCheckedItems().length === 0) {
        delete checkedItems[parentHash];
      }
    }
  }
}

function removeHash(list, hash) {
  var checkedItems = checked.get(list);

  if (checkedItems[hash]) {
    checkedItems[hash].uncheckAll();
    delete checkedItems[hash];
  }
}

function removeAllItems(list, parentIds, id) {
  var dataIndex = index.get(list);
  var indexItem = dataIndex.getFromIndex(parentIds, id);

  if (indexItem) {
    var hash = dataIndex.getHash(indexItem);
    removeHash(list, hash);
  }
}

function addItem(list, parentIds, id) {
  var checkedItems = checked.get(list);
  var dataIndex = index.get(list);
  var indexItem = dataIndex.getFromIndex(parentIds, id);

  if (indexItem) {
    var parentHash = indexItem.parentHash;
    var parents = dataIndex.getParents(indexItem);
    if (!checkedItems[parentHash]) checkedItems[parentHash] = new CheckedHashItem(parents);
    var hashItem = checkedItems[parentHash];
    hashItem.addCheckedItem(indexItem.item);
  }
}

function addAllItems(list, parentIds, id) {
  var checkedItems = checked.get(list);
  var dataIndex = index.get(list);
  var indexItem = dataIndex.getFromIndex(parentIds, id);

  if (indexItem) {
    var hash = dataIndex.getHash(indexItem);
    var parents = [].concat(dataIndex.getParents(indexItem), [indexItem.item]);
    var childHashes = getChildHashesOfCheckedItems(list, hash) || [];
    childHashes.forEach(function (h) {
      removeHash(list, h);
    });
    if (!checkedItems[hash]) checkedItems[hash] = new CheckedHashItem(parents);
    var hashItem = checkedItems[hash];
    hashItem.checkAll();
  }
}

function preCheckItems(list, preCheckedItems) {
  var dataIndex = index.get(list);

  var getHash = function getHash(parentId, id) {
    return parentId ? parentId + "_" + id : "" + id;
  };

  clearAll(list);

  if (dataIndex && preCheckedItems) {
    // creating a hash for pre-checked items to increase speed of searching
    var hashOfPreChecked = [];
    preCheckedItems.forEach(function (i) {
      var hs = getHash(i.parentId, i.id);
      hashOfPreChecked[hs] = i;
    });
    dataIndex.forEach(function (item, parentIds) {
      var hs = getHash(parentIds.length > 0 ? parentIds[parentIds.length - 1] : null, item.id);
      var found = hashOfPreChecked[hs];

      if (found) {
        if (found.isCheckedAll && Array.isArray(item.children) && item.children.length > 0) {
          addAllItems(list, parentIds, item.id);
        } else {
          addItem(list, parentIds, item.id);
        }
      }
    });
  }
}

function afterUpdate(list) {
  lastUpdate.set(list, Date.now());
}

var CheckedItemHashList =
/*#__PURE__*/
function (_BaseModel) {
  _inheritsLoose(CheckedItemHashList, _BaseModel);

  function CheckedItemHashList(dataSourceProvider) {
    var _this;

    _this = _BaseModel.call(this, dataSourceProvider) || this;

    _defineProperty(_assertThisInitialized(_this), "get", function () {
      return checked.get(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "getAllCheckedItems", function () {
      var checkedHashArray = checked.get(_assertThisInitialized(_this));
      var list = [];
      Object.keys(checkedHashArray).forEach(function (key) {
        list = list.concat(checkedHashArray[key].getCheckedItems());
      });
      return list;
    });

    _defineProperty(_assertThisInitialized(_this), "getCheckedItems", function (parentIds) {
      if (parentIds === void 0) {
        parentIds = [];
      }

      var checkedHashItem = _this.getHashItem(parentIds);

      var result = [];

      if (checkedHashItem) {
        result = checkedHashItem.getCheckedItems();
      }

      return result;
    });

    _defineProperty(_assertThisInitialized(_this), "getIsCheckedAll", function (parentIds) {
      if (parentIds === void 0) {
        parentIds = [];
      }

      var checkedHashItem = _this.getHashItem(parentIds);

      return checkedHashItem ? checkedHashItem.isCheckedAll() : false;
    });

    _defineProperty(_assertThisInitialized(_this), "getCheckedItemsCount", function () {
      var checkedHashArray = checked.get(_assertThisInitialized(_this));
      var count = 0;
      Object.keys(checkedHashArray).forEach(function (key) {
        count += checkedHashArray[key].getCheckedItems().length;
      });
      return count;
    });

    _defineProperty(_assertThisInitialized(_this), "getId", function () {
      return providerId.get(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "getHashItem", function (parentIds) {
      if (parentIds === void 0) {
        parentIds = [];
      }

      var checkedHashArray = checked.get(_assertThisInitialized(_this));
      var dataIndex = index.get(_assertThisInitialized(_this));
      var hash = dataIndex.getHashFromIds(parentIds);

      if (hash === '' || !checkedHashArray[hash]) {
        return null;
      }

      return checkedHashArray[hash];
    });

    _defineProperty(_assertThisInitialized(_this), "getLastUpdateStamp", function () {
      return lastUpdate.get(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "getCheckedOutput", function () {
      var resultObject = {
        dataSourceProviderId: _this.getId(),
        checked: []
      };
      var checkedOutput = new CheckedOutput();
      var hashes = checked.get(_assertThisInitialized(_this));
      Object.keys(hashes).forEach(function (hash) {
        var checkedHashItem = hashes[hash];
        checkedOutput.add(checkedHashItem);
      });
      resultObject.checked = checkedOutput.get();
      return resultObject;
    });

    _defineProperty(_assertThisInitialized(_this), "add", function (parentIds, id) {
      addItem(_assertThisInitialized(_this), parentIds, id);
      afterUpdate(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "addAll", function (parentIds, id) {
      addAllItems(_assertThisInitialized(_this), parentIds, id);
      afterUpdate(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "createCopy", function () {
      var copy = new CheckedItemHashList(sourceProvider.get(_assertThisInitialized(_this)));
      providerId.set(copy, providerId.get(_assertThisInitialized(_this)));
      lastUpdate.set(copy, lastUpdate.get(_assertThisInitialized(_this)));
      index.set(copy, index.get(_assertThisInitialized(_this)).clone());
      var chkd = Object.assign({}, checked.get(_assertThisInitialized(_this)));
      Object.keys(chkd).forEach(function (key) {
        chkd[key] = chkd[key].createCopy();
      });
      checked.set(copy, chkd);
      return copy;
    });

    _defineProperty(_assertThisInitialized(_this), "clearAll", function () {
      clearAll(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "preCheckItems", function (preCheckedItems) {
      preCheckItems(_assertThisInitialized(_this), preCheckedItems);
      afterUpdate(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "remove", function (parentIds, id) {
      removeItem(_assertThisInitialized(_this), parentIds, id);
      afterUpdate(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "removeAll", function (parentIds, id) {
      removeAllItems(_assertThisInitialized(_this), parentIds, id);
      afterUpdate(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "removeHash", function (hash) {
      removeHash(_assertThisInitialized(_this), hash);
      afterUpdate(_assertThisInitialized(_this));
    });

    _defineProperty(_assertThisInitialized(_this), "toString", function () {
      var list = checked.get(_assertThisInitialized(_this));
      var result = {};
      Object.keys(list).forEach(function (key) {
        var item = list[key];
        result[key] = {
          checkedAll: item.isCheckedAll(),
          checkedItems: item.getCheckedItems()
        };
      });
      return JSON.stringify({
        id: _this.getId(),
        lastUpdateStamp: _this.getLastUpdateStamp(),
        checked: result
      }, null, 2);
    });

    sourceProvider.set(_assertThisInitialized(_this), dataSourceProvider);
    providerId.set(_assertThisInitialized(_this), dataSourceProvider.id);
    lastUpdate.set(_assertThisInitialized(_this), 0);
    checked.set(_assertThisInitialized(_this), {});
    index.set(_assertThisInitialized(_this), dataSourceProvider.getIndex());
    return _this;
  }

  return CheckedItemHashList;
}(BaseModel);

export default CheckedItemHashList;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tb2RlbHMvY2hlY2tlZC1pdGVtcy9jaGVja2VkLWl0ZW0taGFzaC1saXN0LmpzIl0sIm5hbWVzIjpbIkJhc2VNb2RlbCIsIkNoZWNrZWRIYXNoSXRlbSIsIkNoZWNrZWRPdXRwdXQiLCJzb3VyY2VQcm92aWRlciIsIldlYWtNYXAiLCJwcm92aWRlcklkIiwiY2hlY2tlZCIsImluZGV4IiwibGFzdFVwZGF0ZSIsImNsZWFyQWxsIiwibGlzdCIsInNldCIsImdldENoaWxkSGFzaGVzT2ZDaGVja2VkSXRlbXMiLCJoYXNoIiwiY2hlY2tlZEl0ZW1zIiwiZ2V0IiwiaGFzaGVzIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJjdXJyZW50SGFzaCIsImluZGV4T2YiLCJwdXNoIiwicmVtb3ZlSXRlbSIsInBhcmVudElkcyIsImlkIiwiZGF0YUluZGV4IiwiaW5kZXhJdGVtIiwiZ2V0RnJvbUluZGV4IiwicGFyZW50SGFzaCIsInJlbW92ZUNoZWNrZWRJdGVtIiwiaXRlbSIsImdldENoZWNrZWRJdGVtcyIsImxlbmd0aCIsInJlbW92ZUhhc2giLCJ1bmNoZWNrQWxsIiwicmVtb3ZlQWxsSXRlbXMiLCJnZXRIYXNoIiwiYWRkSXRlbSIsInBhcmVudHMiLCJnZXRQYXJlbnRzIiwiaGFzaEl0ZW0iLCJhZGRDaGVja2VkSXRlbSIsImFkZEFsbEl0ZW1zIiwiY2hpbGRIYXNoZXMiLCJoIiwiY2hlY2tBbGwiLCJwcmVDaGVja0l0ZW1zIiwicHJlQ2hlY2tlZEl0ZW1zIiwicGFyZW50SWQiLCJoYXNoT2ZQcmVDaGVja2VkIiwiaSIsImhzIiwiZm91bmQiLCJpc0NoZWNrZWRBbGwiLCJBcnJheSIsImlzQXJyYXkiLCJjaGlsZHJlbiIsImFmdGVyVXBkYXRlIiwiRGF0ZSIsIm5vdyIsIkNoZWNrZWRJdGVtSGFzaExpc3QiLCJkYXRhU291cmNlUHJvdmlkZXIiLCJjaGVja2VkSGFzaEFycmF5Iiwia2V5IiwiY29uY2F0IiwiY2hlY2tlZEhhc2hJdGVtIiwiZ2V0SGFzaEl0ZW0iLCJyZXN1bHQiLCJjb3VudCIsImdldEhhc2hGcm9tSWRzIiwicmVzdWx0T2JqZWN0IiwiZGF0YVNvdXJjZVByb3ZpZGVySWQiLCJnZXRJZCIsImNoZWNrZWRPdXRwdXQiLCJhZGQiLCJjb3B5IiwiY2xvbmUiLCJjaGtkIiwiYXNzaWduIiwiY3JlYXRlQ29weSIsImNoZWNrZWRBbGwiLCJKU09OIiwic3RyaW5naWZ5IiwibGFzdFVwZGF0ZVN0YW1wIiwiZ2V0TGFzdFVwZGF0ZVN0YW1wIiwiZ2V0SW5kZXgiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLE9BQU9BLFNBQVAsTUFBc0IsU0FBdEI7QUFDQSxPQUFPQyxlQUFQLE1BQTRCLHFCQUE1QjtBQUNBLE9BQU9DLGFBQVAsTUFBMEIsa0JBQTFCO0FBRUEsSUFBTUMsY0FBYyxHQUFHLElBQUlDLE9BQUosRUFBdkI7QUFDQSxJQUFNQyxVQUFVLEdBQUcsSUFBSUQsT0FBSixFQUFuQjtBQUNBLElBQU1FLE9BQU8sR0FBRyxJQUFJRixPQUFKLEVBQWhCO0FBQ0EsSUFBTUcsS0FBSyxHQUFHLElBQUlILE9BQUosRUFBZDtBQUNBLElBQU1JLFVBQVUsR0FBRyxJQUFJSixPQUFKLEVBQW5COztBQUVBLFNBQVNLLFFBQVQsQ0FBa0JDLElBQWxCLEVBQXdCO0FBQ3RCSixFQUFBQSxPQUFPLENBQUNLLEdBQVIsQ0FBWUQsSUFBWixFQUFrQixFQUFsQjtBQUNEOztBQUVELFNBQVNFLDRCQUFULENBQXNDRixJQUF0QyxFQUE0Q0csSUFBNUMsRUFBa0Q7QUFDaEQsTUFBTUMsWUFBWSxHQUFHUixPQUFPLENBQUNTLEdBQVIsQ0FBWUwsSUFBWixDQUFyQjtBQUNBLE1BQU1NLE1BQU0sR0FBRyxFQUFmO0FBQ0FDLEVBQUFBLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZSixZQUFaLEVBQTBCSyxPQUExQixDQUFrQyxVQUFDQyxXQUFELEVBQWlCO0FBQ2pELFFBQUlQLElBQUksS0FBS08sV0FBVCxJQUF3QkEsV0FBVyxDQUFDQyxPQUFaLENBQW9CUixJ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QUFyQjtBQUNBTCxJQUFBQSxPQUFPLENBQUNLLEdBQVIsZ0NBQWtCLEVBQWxCO0FBQ0FKLElBQUFBLEtBQUssQ0FBQ0ksR0FBTixnQ0FBZ0JtRCxrQkFBa0IsQ0FBQ3dCLFFBQW5CLEVBQWhCO0FBTjhCO0FBTy9COzs7RUFSK0J0RixTOztBQStJbEMsZUFBZTZELG1CQUFmIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEJhc2VNb2RlbCBmcm9tICcuLi9iYXNlJztcbmltcG9ydCBDaGVja2VkSGFzaEl0ZW0gZnJvbSAnLi9jaGVja2VkLWhhc2gtaXRlbSc7XG5pbXBvcnQgQ2hlY2tlZE91dHB1dCBmcm9tICcuL2NoZWNrZWQtb3V0cHV0JztcblxuY29uc3Qgc291cmNlUHJvdmlkZXIgPSBuZXcgV2Vha01hcCgpO1xuY29uc3QgcHJvdmlkZXJJZCA9IG5ldyBXZWFrTWFwKCk7XG5jb25zdCBjaGVja2VkID0gbmV3IFdlYWtNYXAoKTtcbmNvbnN0IGluZGV4ID0gbmV3IFdlYWtNYXAoKTtcbmNvbnN0IGxhc3RVcGRhdGUgPSBuZXcgV2Vha01hcCgpO1xuXG5mdW5jdGlvbiBjbGVhckFsbChsaXN0KSB7XG4gIGNoZWNrZWQuc2V0KGxpc3QsIHt9KTtcbn1cblxuZnVuY3Rpb24gZ2V0Q2hpbGRIYXNoZXNPZkNoZWNrZWRJdGVtcyhsaXN0LCBoYXNoKSB7XG4gIGNvbnN0IGNoZWNrZWRJdGVtcyA9IGNoZWNrZWQuZ2V0KGxpc3QpO1xuICBjb25zdCBoYXNoZXMgPSBbXTtcbiAgT2JqZWN0LmtleXMoY2hlY2tlZEl0ZW1zKS5mb3JFYWNoKChjdXJyZW50SGFzaCkgPT4ge1xuICAgIGlmIChoYXNoICE9PSBjdXJyZW50SGFzaCAmJiBjdXJyZW50SGFzaC5pbmRleE9mKGhhc2gpID09PSAwKSB7XG4gICAgICBoYXNoZXMucHVzaChjdXJyZW50SGFzaCk7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gaGFzaGVzO1xufVxuXG5mdW5jdGlvbiByZW1vdmVJdGVtKGxpc3QsIHBhcmVudElkcywgaWQpIHtcbiAgY29uc3QgY2hlY2tlZEl0ZW1zID0gY2hlY2tlZC5nZXQobGlzdCk7XG4gIGNvbnN0IGRhdGFJbmRleCA9IGluZGV4LmdldChsaXN0KTtcbiAgY29uc3QgaW5kZXhJdGVtID0gZGF0YUluZGV4LmdldEZyb21JbmRleChwYXJlbnRJZHMsIGlkKTtcblxuICBpZiAoaW5kZXhJdGVtKSB7XG4gICAgY29uc3QgeyBwYXJlbnRIYXNoIH0gPSBpbmRleEl0ZW07XG5cbiAgICBpZiAoY2hlY2tlZEl0ZW1zW3BhcmVudEhhc2hdKSB7XG4gICAgICBjaGVja2VkSXRlbXNbcGFyZW50SGFzaF0ucmVtb3ZlQ2hlY2tlZEl0ZW0oaW5kZXhJdGVtLml0ZW0pO1xuICAgICAgLy8gQ2hlY2tzIGlmIHRoZXJlIGlzIG5vIGNoZWNrZWQgaXRlbXMsIHRoZW4gcmVtb3ZlcyBhIGhhc2hcbiAgICAgIGlmIChjaGVja2VkSXRlbXNbcGFyZW50SGFzaF0uZ2V0Q2hlY2tlZEl0ZW1zKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGRlbGV0ZSBjaGVja2VkSXRlbXNbcGFyZW50SGFzaF07XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUhhc2gobGlzdCwgaGFzaCkge1xuICBjb25zdCBjaGVja2VkSXRlbXMgPSBjaGVja2VkLmdldChsaXN0KTtcbiAgaWYgKGNoZWNrZWRJdGVtc1toYXNoXSkge1xuICAgIGNoZWNrZWRJdGVtc1toYXNoXS51bmNoZWNrQWxsKCk7XG4gICAgZGVsZXRlIGNoZWNrZWRJdGVtc1toYXNoXTtcbiAgfVxufVxuXG5mdW5jdGlvbiByZW1vdmVBbGxJdGVtcyhsaXN0LCBwYXJlbnRJZHMsIGlkKSB7XG4gIGNvbnN0IGRhdGFJbmRleCA9IGluZGV4LmdldChsaXN0KTtcbiAgY29uc3QgaW5kZXhJdGVtID0gZGF0YUluZGV4LmdldEZyb21JbmRleChwYXJlbnRJZHMsIGlkKTtcblxuICBpZiAoaW5kZXhJdGVtKSB7XG4gICAgY29uc3QgaGFzaCA9IGRhdGFJbmRleC5nZXRIYXNoKGluZGV4SXRlbSk7XG4gICAgcmVtb3ZlSGFzaChsaXN0LCBoYXNoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhZGRJdGVtKGxpc3QsIHBhcmVudElkcywgaWQpIHtcbiAgY29uc3QgY2hlY2tlZEl0ZW1zID0gY2hlY2tlZC5nZXQobGlzdCk7XG4gIGNvbnN0IGRhdGFJbmRleCA9IGluZGV4LmdldChsaXN0KTtcbiAgY29uc3QgaW5kZXhJdGVtID0gZGF0YUluZGV4LmdldEZyb21JbmRleChwYXJlbnRJZHMsIGlkKTtcblxuICBpZiAoaW5kZXhJdGVtKSB7XG4gICAgY29uc3QgeyBwYXJlbnRIYXNoIH0gPSBpbmRleEl0ZW07XG4gICAgY29uc3QgcGFyZW50cyA9IGRhdGFJbmRleC5nZXRQYXJlbnRzKGluZGV4SXRlbSk7XG5cbiAgICBpZiAoIWNoZWNrZWRJdGVtc1twYXJlbnRIYXNoXSkgY2hlY2tlZEl0ZW1zW3BhcmVudEhhc2hdID0gbmV3IENoZWNrZWRIYXNoSXRlbShwYXJlbnRzKTtcblxuICAgIGNvbnN0IGhhc2hJdGVtID0gY2hlY2tlZEl0ZW1zW3BhcmVudEhhc2hdO1xuICAgIGhhc2hJdGVtLmFkZENoZWNrZWRJdGVtKGluZGV4SXRlbS5pdGVtKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhZGRBbGxJdGVtcyhsaXN0LCBwYXJlbnRJZHMsIGlkKSB7XG4gIGNvbnN0IGNoZWNrZWRJdGVtcyA9IGNoZWNrZWQuZ2V0KGxpc3QpO1xuICBjb25zdCBkYXRhSW5kZXggPSBpbmRleC5nZXQobGlzdCk7XG4gIGNvbnN0IGluZGV4SXRlbSA9IGRhdGFJbmRleC5nZXRGcm9tSW5kZXgocGFyZW50SWRzLCBpZCk7XG4gIGlmIChpbmRleEl0ZW0pIHtcbiAgICBjb25zdCBoYXNoID0gZGF0YUluZGV4LmdldEhhc2goaW5kZXhJdGVtKTtcbiAgICBjb25zdCBwYXJlbnRzID0gWy4uLmRhdGFJbmRleC5nZXRQYXJlbnRzKGluZGV4SXRlbSksIGluZGV4SXRlbS5pdGVtXTtcbiAgICBjb25zdCBjaGlsZEhhc2hlcyA9IGdldENoaWxkSGFzaGVzT2ZDaGVja2VkSXRlbXMobGlzdCwgaGFzaCkgfHwgW107XG5cbiAgICBjaGlsZEhhc2hlcy5mb3JFYWNoKChoKSA9PiB7IHJlbW92ZUhhc2gobGlzdCwgaCk7IH0pO1xuXG4gICAgaWYgKCFjaGVja2VkSXRlbXNbaGFzaF0pIGNoZWNrZWRJdGVtc1toYXNoXSA9IG5ldyBDaGVja2VkSGFzaEl0ZW0ocGFyZW50cyk7XG5cbiAgICBjb25zdCBoYXNoSXRlbSA9IGNoZWNrZWRJdGVtc1toYXNoXTtcbiAgICBoYXNoSXRlbS5jaGVja0FsbCgpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHByZUNoZWNrSXRlbXMobGlzdCwgcHJlQ2hlY2tlZEl0ZW1zKSB7XG4gIGNvbnN0IGRhdGFJbmRleCA9IGluZGV4LmdldChsaXN0KTtcbiAgY29uc3QgZ2V0SGFzaCA9IChwYXJlbnRJZCwgaWQpID0+IChcbiAgICBwYXJlbnRJZCA/IGAke3BhcmVudElkfV8ke2lkfWAgOiBgJHtpZH1gXG4gICk7XG4gIGNsZWFyQWxsKGxpc3QpO1xuXG4gIGlmIChkYXRhSW5kZXggJiYgcHJlQ2hlY2tlZEl0ZW1zKSB7XG4gICAgLy8gY3JlYXRpbmcgYSBoYXNoIGZvciBwcmUtY2hlY2tlZCBpdGVtcyB0byBpbmNyZWFzZSBzcGVlZCBvZiBzZWFyY2hpbmdcbiAgICBjb25zdCBoYXNoT2ZQcmVDaGVja2VkID0gW107XG4gICAgcHJlQ2hlY2tlZEl0ZW1zLmZvckVhY2goKGkpID0+IHtcbiAgICAgIGNvbnN0IGhzID0gZ2V0SGFzaChpLnBhcmVudElkLCBpLmlkKTtcbiAgICAgIGhhc2hPZlByZUNoZWNrZWRbaHNdID0gaTtcbiAgICB9KTtcblxuICAgIGRhdGFJbmRleC5mb3JFYWNoKChpdGVtLCBwYXJlbnRJZHMpID0+IHtcbiAgICAgIGNvbnN0IGhzID0gZ2V0SGFzaChwYXJlbnRJZHMubGVuZ3RoID4gMCA/IHBhcmVudElkc1twYXJlbnRJZHMubGVuZ3RoIC0gMV0gOiBudWxsLCBpdGVtLmlkKTtcbiAgICAgIGNvbnN0IGZvdW5kID0gaGFzaE9mUHJlQ2hlY2tlZFtoc107XG4gICAgICBpZiAoZm91bmQpIHtcbiAgICAgICAgaWYgKGZvdW5kLmlzQ2hlY2tlZEFsbCAmJiBBcnJheS5pc0FycmF5KGl0ZW0uY2hpbGRyZW4pICYmIGl0ZW0uY2hpbGRyZW4ubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGFkZEFsbEl0ZW1zKGxpc3QsIHBhcmVudElkcywgaXRlbS5pZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYWRkSXRlbShsaXN0LCBwYXJlbnRJZHMsIGl0ZW0uaWQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gYWZ0ZXJVcGRhdGUobGlzdCkge1xuICBsYXN0VXBkYXRlLnNldChsaXN0LCBEYXRlLm5vdygpKTtcbn1cblxuY2xhc3MgQ2hlY2tlZEl0ZW1IYXNoTGlzdCBleHRlbmRzIEJhc2VNb2RlbCB7XG4gIGNvbnN0cnVjdG9yKGRhdGFTb3VyY2VQcm92aWRlcikge1xuICAgIHN1cGVyKGRhdGFTb3VyY2VQcm92aWRlcik7XG4gICAgc291cmNlUHJvdmlkZXIuc2V0KHRoaXMsIGRhdGFTb3VyY2VQcm92aWRlcik7XG4gICAgcHJvdmlkZXJJZC5zZXQodGhpcywgZGF0YVNvdXJjZVByb3ZpZGVyLmlkKTtcbiAgICBsYXN0VXBkYXRlLnNldCh0aGlzLCAwKTtcbiAgICBjaGVja2VkLnNldCh0aGlzLCB7fSk7XG4gICAgaW5kZXguc2V0KHRoaXMsIGRhdGFTb3VyY2VQcm92aWRlci5nZXRJbmRleCgpKTtcbiAgfVxuXG4gIGdldCA9ICgpID0+IGNoZWNrZWQuZ2V0KHRoaXMpO1xuXG4gIGdldEFsbENoZWNrZWRJdGVtcyA9ICgpID0+IHtcbiAgICBjb25zdCBjaGVja2VkSGFzaEFycmF5ID0gY2hlY2tlZC5nZXQodGhpcyk7XG4gICAgbGV0IGxpc3QgPSBbXTtcbiAgICBPYmplY3Qua2V5cyhjaGVja2VkSGFzaEFycmF5KS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIGxpc3QgPSBsaXN0LmNvbmNhdChjaGVja2VkSGFzaEFycmF5W2tleV0uZ2V0Q2hlY2tlZEl0ZW1zKCkpO1xuICAgIH0pO1xuICAgIHJldHVybiBsaXN0O1xuICB9XG5cbiAgZ2V0Q2hlY2tlZEl0ZW1zID0gKHBhcmVudElkcyA9IFtdKSA9PiB7XG4gICAgY29uc3QgY2hlY2tlZEhhc2hJdGVtID0gdGhpcy5nZXRIYXNoSXRlbShwYXJlbnRJZHMpO1xuICAgIGxldCByZXN1bHQgPSBbXTtcbiAgICBpZiAoY2hlY2tlZEhhc2hJdGVtKSB7XG4gICAgICByZXN1bHQgPSBjaGVja2VkSGFzaEl0ZW0uZ2V0Q2hlY2tlZEl0ZW1zKCk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBnZXRJc0NoZWNrZWRBbGwgPSAocGFyZW50SWRzID0gW10pID0+IHtcbiAgICBjb25zdCBjaGVja2VkSGFzaEl0ZW0gPSB0aGlzLmdldEhhc2hJdGVtKHBhcmVudElkcyk7XG4gICAgcmV0dXJuIGNoZWNrZWRIYXNoSXRlbSA/IGNoZWNrZWRIYXNoSXRlbS5pc0NoZWNrZWRBbGwoKSA6IGZhbHNlO1xuICB9XG5cbiAgZ2V0Q2hlY2tlZEl0ZW1zQ291bnQgPSAoKSA9PiB7XG4gICAgY29uc3QgY2hlY2tlZEhhc2hBcnJheSA9IGNoZWNrZWQuZ2V0KHRoaXMpO1xuICAgIGxldCBjb3VudCA9IDA7XG4gICAgT2JqZWN0LmtleXMoY2hlY2tlZEhhc2hBcnJheSkuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICBjb3VudCArPSBjaGVja2VkSGFzaEFycmF5W2tleV0uZ2V0Q2hlY2tlZEl0ZW1zKCkubGVuZ3RoO1xuICAgIH0pO1xuICAgIHJldHVybiBjb3VudDtcbiAgfVxuXG4gIGdldElkID0gKCkgPT4gcHJvdmlkZXJJZC5nZXQodGhpcyk7XG5cbiAgZ2V0SGFzaEl0ZW0gPSAocGFyZW50SWRzID0gW10pID0+IHtcbiAgICBjb25zdCBjaGVja2VkSGFzaEFycmF5ID0gY2hlY2tlZC5nZXQodGhpcyk7XG4gICAgY29uc3QgZGF0YUluZGV4ID0gaW5kZXguZ2V0KHRoaXMpO1xuICAgIGNvbnN0IGhhc2ggPSBkYXRhSW5kZXguZ2V0SGFzaEZyb21JZHMocGFyZW50SWRzKTtcblxuICAgIGlmIChoYXNoID09PSAnJyB8fCAhY2hlY2tlZEhhc2hBcnJheVtoYXNoXSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHJldHVybiBjaGVja2VkSGFzaEFycmF5W2hhc2hdO1xuICB9O1xuXG4gIGdldExhc3RVcGRhdGVTdGFtcCA9ICgpID0+IGxhc3RVcGRhdGUuZ2V0KHRoaXMpO1xuXG4gIGdldENoZWNrZWRPdXRwdXQgPSAoKSA9PiB7XG4gICAgY29uc3QgcmVzdWx0T2JqZWN0ID0ge1xuICAgICAgZGF0YVNvdXJjZVByb3ZpZGVySWQ6IHRoaXMuZ2V0SWQoKSxcbiAgICAgIGNoZWNrZWQ6IFtdLFxuICAgIH07XG4gICAgY29uc3QgY2hlY2tlZE91dHB1dCA9IG5ldyBDaGVja2VkT3V0cHV0KCk7XG4gICAgY29uc3QgaGFzaGVzID0gY2hlY2tlZC5nZXQodGhpcyk7XG5cbiAgICBPYmplY3Qua2V5cyhoYXNoZXMpLmZvckVhY2goKGhhc2gpID0+IHtcbiAgICAgIGNvbnN0IGNoZWNrZWRIYXNoSXRlbSA9IGhhc2hlc1toYXNoXTtcbiAgICAgIGNoZWNrZWRPdXRwdXQuYWRkKGNoZWNrZWRIYXNoSXRlbSk7XG4gICAgfSk7XG5cbiAgICByZXN1bHRPYmplY3QuY2hlY2tlZCA9IGNoZWNrZWRPdXRwdXQuZ2V0KCk7XG5cbiAgICByZXR1cm4gcmVzdWx0T2JqZWN0O1xuICB9XG5cbiAgYWRkID0gKHBhcmVudElkcywgaWQpID0+IHtcbiAgICBhZGRJdGVtKHRoaXMsIHBhcmVudElkcywgaWQpO1xuICAgIGFmdGVyVXBkYXRlKHRoaXMpO1xuICB9XG5cbiAgYWRkQWxsID0gKHBhcmVudElkcywgaWQpID0+IHtcbiAgICBhZGRBbGxJdGVtcyh0aGlzLCBwYXJlbnRJZHMsIGlkKTtcbiAgICBhZnRlclVwZGF0ZSh0aGlzKTtcbiAgfVxuXG4gIGNyZWF0ZUNvcHkgPSAoKSA9PiB7XG4gICAgY29uc3QgY29weSA9IG5ldyBDaGVja2VkSXRlbUhhc2hMaXN0KHNvdXJjZVByb3ZpZGVyLmdldCh0aGlzKSk7XG5cbiAgICBwcm92aWRlcklkLnNldChjb3B5LCBwcm92aWRlcklkLmdldCh0aGlzKSk7XG4gICAgbGFzdFVwZGF0ZS5zZXQoY29weSwgbGFzdFVwZGF0ZS5nZXQodGhpcykpO1xuICAgIGluZGV4LnNldChjb3B5LCBpbmRleC5nZXQodGhpcykuY2xvbmUoKSk7XG5cbiAgICBjb25zdCBjaGtkID0gT2JqZWN0LmFzc2lnbih7fSwgY2hlY2tlZC5nZXQodGhpcykpO1xuICAgIE9iamVjdC5rZXlzKGNoa2QpLmZvckVhY2goKGtleSkgPT4geyBjaGtkW2tleV0gPSBjaGtkW2tleV0uY3JlYXRlQ29weSgpOyB9KTtcbiAgICBjaGVja2VkLnNldChjb3B5LCBjaGtkKTtcblxuICAgIHJldHVybiBjb3B5O1xuICB9XG5cbiAgY2xlYXJBbGwgPSAoKSA9PiB7XG4gICAgY2xlYXJBbGwodGhpcyk7XG4gIH1cblxuICBwcmVDaGVja0l0ZW1zID0gKHByZUNoZWNrZWRJdGVtcykgPT4ge1xuICAgIHByZUNoZWNrSXRlbXModGhpcywgcHJlQ2hlY2tlZEl0ZW1zKTtcbiAgICBhZnRlclVwZGF0ZSh0aGlzKTtcbiAgfVxuXG4gIHJlbW92ZSA9IChwYXJlbnRJZHMsIGlkKSA9PiB7XG4gICAgcmVtb3ZlSXRlbSh0aGlzLCBwYXJlbnRJZHMsIGlkKTtcbiAgICBhZnRlclVwZGF0ZSh0aGlzKTtcbiAgfVxuXG4gIHJlbW92ZUFsbCA9IChwYXJlbnRJZHMsIGlkKSA9PiB7XG4gICAgcmVtb3ZlQWxsSXRlbXModGhpcywgcGFyZW50SWRzLCBpZCk7XG4gICAgYWZ0ZXJVcGRhdGUodGhpcyk7XG4gIH1cblxuICByZW1vdmVIYXNoID0gKGhhc2gpID0+IHtcbiAgICByZW1vdmVIYXNoKHRoaXMsIGhhc2gpO1xuICAgIGFmdGVyVXBkYXRlKHRoaXMpO1xuICB9XG5cbiAgdG9TdHJpbmcgPSAoKSA9PiB7XG4gICAgY29uc3QgbGlzdCA9IGNoZWNrZWQuZ2V0KHRoaXMpO1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIE9iamVjdC5rZXlzKGxpc3QpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgY29uc3QgaXRlbSA9IGxpc3Rba2V5XTtcbiAgICAgIHJlc3VsdFtrZXldID0ge1xuICAgICAgICBjaGVja2VkQWxsOiBpdGVtLmlzQ2hlY2tlZEFsbCgpLFxuICAgICAgICBjaGVja2VkSXRlbXM6IGl0ZW0uZ2V0Q2hlY2tlZEl0ZW1zKCksXG4gICAgICB9O1xuICAgIH0pO1xuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBpZDogdGhpcy5nZXRJZCgpLFxuICAgICAgbGFzdFVwZGF0ZVN0YW1wOiB0aGlzLmdldExhc3RVcGRhdGVTdGFtcCgpLFxuICAgICAgY2hlY2tlZDogcmVzdWx0LFxuICAgIH0sIG51bGwsIDIpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IENoZWNrZWRJdGVtSGFzaExpc3Q7XG4iXX0=