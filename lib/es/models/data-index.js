function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/* eslint-disable no-param-reassign */
var index = new WeakMap();

function getHashFromIds(ids) {
  return ids.join('_');
}

function getIdsFromHash(hash) {
  return hash ? hash.split('_') : [];
}

function getFromIndex(obj, ids) {
  var dataIndex = index.get(obj);
  var hash = getHashFromIds(ids);
  return dataIndex[hash] ? Object.assign({}, dataIndex[hash]) : null;
}

function getParents(obj, hash, parents) {
  if (parents === void 0) {
    parents = [];
  }

  var ids = getIdsFromHash(hash);

  if (ids.length > 1) {
    ids.pop();
    var newHash = getHashFromIds(ids);
    var dataIndex = index.get(obj);
    if (dataIndex[newHash] === undefined) throw new Error("Hash '" + newHash + "' is missed from an index");
    parents.unshift(dataIndex[newHash].item);
    getParents(obj, newHash, parents);
  }

  return parents;
}

function addIdToHash(hash, addedId) {
  var ids = getIdsFromHash(hash);
  return getHashFromIds([].concat(ids, [addedId]));
}

function createIndex(items, indexResult, parents) {
  if (indexResult === void 0) {
    indexResult = {};
  }

  if (parents === void 0) {
    parents = [];
  }

  Object.keys(items).forEach(function (key) {
    var item = items[key];
    var allIds = [].concat(parents, [item.id]);
    var hashKey = getHashFromIds(allIds);
    indexResult[hashKey] = {
      parentHash: getHashFromIds(parents),
      item: item
    };

    if (item.children && Array.isArray(item.children) && item.children.length > 0) {
      createIndex(item.children, indexResult, allIds);
    }
  });
  return indexResult;
}

var DataIndex = function DataIndex(data) {
  var _this = this;

  _defineProperty(this, "get", function () {
    return Object.assign({}, index.get(_this));
  });

  _defineProperty(this, "getHash", function (indexItem) {
    if (!indexItem) throw new Error('DataIndex::getParents(): there is no indexItem');
    if (!indexItem.item) throw new Error('DataIndex::getParents(): item is not found in indexItem');
    return addIdToHash(indexItem.parentHash, indexItem.item.id);
  });

  _defineProperty(this, "getHashFromIds", function (ids) {
    return getHashFromIds(ids);
  });

  _defineProperty(this, "getParentsByHash", function (hash) {
    return getParents(_this, hash);
  });

  _defineProperty(this, "getParents", function (indexItem) {
    return getParents(_this, _this.getHash(indexItem));
  });

  _defineProperty(this, "getFromIndex", function (parentIds, id) {
    return getFromIndex(_this, [].concat(parentIds, [id]));
  });

  _defineProperty(this, "clone", function () {
    return new DataIndex(_this);
  });

  _defineProperty(this, "forEach", function (callBack) {
    var dataIndex = index.get(_this);
    Object.keys(dataIndex).forEach(function (key) {
      var indexItem = dataIndex[key];
      callBack(indexItem.item, getIdsFromHash(indexItem.parentHash));
    });
  });

  if (data instanceof DataIndex) {
    index.set(this, data.get());
  } else {
    index.set(this, createIndex(data));
  }
};

export { DataIndex as default };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tb2RlbHMvZGF0YS1pbmRleC5qcyJdLCJuYW1lcyI6WyJpbmRleCIsIldlYWtNYXAiLCJnZXRIYXNoRnJvbUlkcyIsImlkcyIsImpvaW4iLCJnZXRJZHNGcm9tSGFzaCIsImhhc2giLCJzcGxpdCIsImdldEZyb21JbmRleCIsIm9iaiIsImRhdGFJbmRleCIsImdldCIsIk9iamVjdCIsImFzc2lnbiIsImdldFBhcmVudHMiLCJwYXJlbnRzIiwibGVuZ3RoIiwicG9wIiwibmV3SGFzaCIsInVuZGVmaW5lZCIsIkVycm9yIiwidW5zaGlmdCIsIml0ZW0iLCJhZGRJZFRvSGFzaCIsImFkZGVkSWQiLCJjcmVhdGVJbmRleCIsIml0ZW1zIiwiaW5kZXhSZXN1bHQiLCJrZXlzIiwiZm9yRWFjaCIsImtleSIsImFsbElkcyIsImlkIiwiaGFzaEtleSIsInBhcmVudEhhc2giLCJjaGlsZHJlbiIsIkFycmF5IiwiaXNBcnJheSIsIkRhdGFJbmRleCIsImRhdGEiLCJpbmRleEl0ZW0iLCJnZXRIYXNoIiwicGFyZW50SWRzIiwiY2FsbEJhY2siLCJzZXQiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFFQSxJQUFNQSxLQUFLLEdBQUcsSUFBSUMsT0FBSixFQUFkOztBQUVBLFNBQVNDLGNBQVQsQ0FBd0JDLEdBQXhCLEVBQTZCO0FBQzNCLFNBQU9BLEdBQUcsQ0FBQ0MsSUFBSixDQUFTLEdBQVQsQ0FBUDtBQUNEOztBQUVELFNBQVNDLGNBQVQsQ0FBd0JDLElBQXhCLEVBQThCO0FBQzVCLFNBQU9BLElBQUksR0FBR0EsSUFBSSxDQUFDQyxLQUFMLENBQVcsR0FBWCxDQUFILEdBQXFCLEVBQWhDO0FBQ0Q7O0FBRUQsU0FBU0MsWUFBVCxDQUFzQkMsR0FBdEIsRUFBMkJOLEdBQTNCLEVBQWdDO0FBQzlCLE1BQU1PLFNBQVMsR0FBR1YsS0FBSyxDQUFDVyxHQUFOLENBQVVGLEdBQVYsQ0FBbEI7QUFDQSxNQUFNSCxJQUFJLEdBQUdKLGNBQWMsQ0FBQ0MsR0FB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QVI7QUFDRCxLQUhEO0FBSUQsR0FqQ2lCOztBQUNoQixNQUFJSyxJQUFJLFlBQVlELFNBQXBCLEVBQStCO0FBQzdCdEMsSUFBQUEsS0FBSyxDQUFDNEMsR0FBTixDQUFVLElBQVYsRUFBZ0JMLElBQUksQ0FBQzVCLEdBQUwsRUFBaEI7QUFDRCxHQUZELE1BRU87QUFDTFgsSUFBQUEsS0FBSyxDQUFDNEMsR0FBTixDQUFVLElBQVYsRUFBZ0JuQixXQUFXLENBQUNjLElBQUQsQ0FBM0I7QUFDRDtBQUNGLEM7O1NBUGtCRCxTIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tcGFyYW0tcmVhc3NpZ24gKi9cblxuY29uc3QgaW5kZXggPSBuZXcgV2Vha01hcCgpO1xuXG5mdW5jdGlvbiBnZXRIYXNoRnJvbUlkcyhpZHMpIHtcbiAgcmV0dXJuIGlkcy5qb2luKCdfJyk7XG59XG5cbmZ1bmN0aW9uIGdldElkc0Zyb21IYXNoKGhhc2gpIHtcbiAgcmV0dXJuIGhhc2ggPyBoYXNoLnNwbGl0KCdfJykgOiBbXTtcbn1cblxuZnVuY3Rpb24gZ2V0RnJvbUluZGV4KG9iaiwgaWRzKSB7XG4gIGNvbnN0IGRhdGFJbmRleCA9IGluZGV4LmdldChvYmopO1xuICBjb25zdCBoYXNoID0gZ2V0SGFzaEZyb21JZHMoaWRzKTtcbiAgcmV0dXJuIGRhdGFJbmRleFtoYXNoXSA/IE9iamVjdC5hc3NpZ24oe30sIGRhdGFJbmRleFtoYXNoXSkgOiBudWxsO1xufVxuXG5mdW5jdGlvbiBnZXRQYXJlbnRzKG9iaiwgaGFzaCwgcGFyZW50cyA9IFtdKSB7XG4gIGNvbnN0IGlkcyA9IGdldElkc0Zyb21IYXNoKGhhc2gpO1xuICBpZiAoaWRzLmxlbmd0aCA+IDEpIHtcbiAgICBpZHMucG9wKCk7XG4gICAgY29uc3QgbmV3SGFzaCA9IGdldEhhc2hGcm9tSWRzKGlkcyk7XG4gICAgY29uc3QgZGF0YUluZGV4ID0gaW5kZXguZ2V0KG9iaik7XG4gICAgaWYgKGRhdGFJbmRleFtuZXdIYXNoXSA9PT0gdW5kZWZpbmVkKSB0aHJvdyBuZXcgRXJyb3IoYEhhc2ggJyR7bmV3SGFzaH0nIGlzIG1pc3NlZCBmcm9tIGFuIGluZGV4YCk7XG4gICAgcGFyZW50cy51bnNoaWZ0KGRhdGFJbmRleFtuZXdIYXNoXS5pdGVtKTtcbiAgICBnZXRQYXJlbnRzKG9iaiwgbmV3SGFzaCwgcGFyZW50cyk7XG4gIH1cbiAgcmV0dXJuIHBhcmVudHM7XG59XG5cbmZ1bmN0aW9uIGFkZElkVG9IYXNoKGhhc2gsIGFkZGVkSWQpIHtcbiAgY29uc3QgaWRzID0gZ2V0SWRzRnJvbUhhc2goaGFzaCk7XG4gIHJldHVybiBnZXRIYXNoRnJvbUlkcyhbLi4uaWRzLCBhZGRlZElkXSk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUluZGV4KGl0ZW1zLCBpbmRleFJlc3VsdCA9IHt9LCBwYXJlbnRzID0gW10pIHtcbiAgT2JqZWN0LmtleXMoaXRlbXMpLmZvckVhY2goKGtleSkgPT4ge1xuICAgIGNvbnN0IGl0ZW0gPSBpdGVtc1trZXldO1xuICAgIGNvbnN0IGFsbElkcyA9IFsuLi5wYXJlbnRzLCBpdGVtLmlkXTtcbiAgICBjb25zdCBoYXNoS2V5ID0gZ2V0SGFzaEZyb21JZHMoYWxsSWRzKTtcbiAgICBpbmRleFJlc3VsdFtoYXNoS2V5XSA9IHtcbiAgICAgIHBhcmVudEhhc2g6IGdldEhhc2hGcm9tSWRzKHBhcmVudHMpLFxuICAgICAgaXRlbSxcbiAgICB9O1xuICAgIGlmIChpdGVtLmNoaWxkcmVuICYmIEFycmF5LmlzQXJyYXkoaXRlbS5jaGlsZHJlbikgJiYgaXRlbS5jaGlsZHJlbi5sZW5ndGggPiAwKSB7XG4gICAgICBjcmVhdGVJbmRleChpdGVtLmNoaWxkcmVuLCBpbmRleFJlc3VsdCwgYWxsSWRzKTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBpbmRleFJlc3VsdDtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRGF0YUluZGV4IHtcbiAgY29uc3RydWN0b3IoZGF0YSkge1xuICAgIGlmIChkYXRhIGluc3RhbmNlb2YgRGF0YUluZGV4KSB7XG4gICAgICBpbmRleC5zZXQodGhpcywgZGF0YS5nZXQoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGluZGV4LnNldCh0aGlzLCBjcmVhdGVJbmRleChkYXRhKSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0ID0gKCkgPT4gT2JqZWN0LmFzc2lnbih7fSwgaW5kZXguZ2V0KHRoaXMpKTtcblxuICBnZXRIYXNoID0gKGluZGV4SXRlbSkgPT4ge1xuICAgIGlmICghaW5kZXhJdGVtKSB0aHJvdyBuZXcgRXJyb3IoJ0RhdGFJbmRleDo6Z2V0UGFyZW50cygpOiB0aGVyZSBpcyBubyBpbmRleEl0ZW0nKTtcbiAgICBpZiAoIWluZGV4SXRlbS5pdGVtKSB0aHJvdyBuZXcgRXJyb3IoJ0RhdGFJbmRleDo6Z2V0UGFyZW50cygpOiBpdGVtIGlzIG5vdCBmb3VuZCBpbiBpbmRleEl0ZW0nKTtcblxuICAgIHJldHVybiBhZGRJZFRvSGFzaChpbmRleEl0ZW0ucGFyZW50SGFzaCwgaW5kZXhJdGVtLml0ZW0uaWQpO1xuICB9XG5cbiAgZ2V0SGFzaEZyb21JZHMgPSBpZHMgPT4gZ2V0SGFzaEZyb21JZHMoaWRzKTtcblxuICBnZXRQYXJlbnRzQnlIYXNoID0gaGFzaCA9PiBnZXRQYXJlbnRzKHRoaXMsIGhhc2gpO1xuXG4gIGdldFBhcmVudHMgPSBpbmRleEl0ZW0gPT4gZ2V0UGFyZW50cyh0aGlzLCB0aGlzLmdldEhhc2goaW5kZXhJdGVtKSk7XG5cbiAgZ2V0RnJvbUluZGV4ID0gKHBhcmVudElkcywgaWQpID0+IGdldEZyb21JbmRleCh0aGlzLCBbLi4ucGFyZW50SWRzLCBpZF0pXG5cbiAgY2xvbmUgPSAoKSA9PiBuZXcgRGF0YUluZGV4KHRoaXMpO1xuXG4gIGZvckVhY2ggPSAoY2FsbEJhY2spID0+IHtcbiAgICBjb25zdCBkYXRhSW5kZXggPSBpbmRleC5nZXQodGhpcyk7XG4gICAgT2JqZWN0LmtleXMoZGF0YUluZGV4KS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIGNvbnN0IGluZGV4SXRlbSA9IGRhdGFJbmRleFtrZXldO1xuICAgICAgY2FsbEJhY2soaW5kZXhJdGVtLml0ZW0sIGdldElkc0Zyb21IYXNoKGluZGV4SXRlbS5wYXJlbnRIYXNoKSk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==