function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/* eslint-disable react/no-unused-state */
import React from 'react';
import PropTypes from 'prop-types';
import { Modal } from 'react-bootstrap';
import ViewTopBar from './top-bar.component';
import ViewTabs from './tabs.component';
import SelectedItems from './selected-items';
import GroupName from './group-name';
import { preCheckedItemsListShape } from '../../types';
import { dataSourceProviderType } from '../../services/types';
import calculateGroupName from '../../services/group-name-calculation';
import './view.scss';

function getFirstCheckedItemHashList(lists) {
  var dataSourceKeys = Object.keys(lists);
  if (dataSourceKeys.length === 0) return null;
  return lists[dataSourceKeys[0]];
}

var HierarchySelectorView =
/*#__PURE__*/
function (_React$PureComponent) {
  _inheritsLoose(HierarchySelectorView, _React$PureComponent);

  function HierarchySelectorView(props) {
    var _this;

    _this = _React$PureComponent.call(this, props) || this;

    _defineProperty(_assertThisInitialized(_this), "getInitialLastUpdateStamp", function () {
      return '0';
    });

    _defineProperty(_assertThisInitialized(_this), "getLastUpdateStamp", function () {
      var stamp = Object.keys(_this.state.checkedItemHashLists).map(function (i) {
        return _this.state.checkedItemHashLists[i].getLastUpdateStamp();
      }).join('-');
      return stamp;
    });

    _defineProperty(_assertThisInitialized(_this), "getGroupName", function (hashList) {
      var _this$state = _this.state,
          groupName = _this$state.groupName,
          groupNameChangedByUser = _this$state.groupNameChangedByUser;
      return calculateGroupName(groupName, groupNameChangedByUser, hashList);
    });

    _defineProperty(_assertThisInitialized(_this), "getContent", function () {
      var listsHashArray = _this.state.checkedItemHashLists;
      var tabsItems = [{
        title: '',
        dataSourceProvider: _this.props.dataSourceProvider
      }];
      return React.createElement("div", {
        className: "oc-hierarchy-selector-view"
      }, React.createElement("div", {
        className: "oc-hierarchy-selector-tabs"
      }, React.createElement(ViewTabs, {
        allLabel: _this.props.allLabel,
        items: tabsItems,
        listItemRenderFunction: _this.props.listItemRenderFunction,
        onCheckListChange: _this.checkListChangeHandler,
        hideSingleTab: true,
        searchPlaceHolder: _this.props.searchPlaceHolder,
        searchTooltip: _this.props.searchTooltip
      })), React.createElement("div", {
        className: "oc-hierarchy-selector-selected-container"
      }, !_this.props.standalone && !_this.props.hideGroupNameInput && React.createElement(GroupName, {
        label: _this.props.groupNameLabel,
        placeHolder: _this.props.groupNamePlaceHolder,
        initialValue: _this.state.groupName,
        onChange: _this.groupNameChangeHandler
      }), React.createElement(SelectedItems, {
        allLabel: _this.props.allLabel,
        listLabel: _this.props.selectedItemListLabel,
        checkedItemLists: Object.keys(listsHashArray).map(function (i) {
          return listsHashArray[i];
        }),
        itemRenderFunction: _this.props.selectedItemRenderFunction,
        onItemRemove: _this.itemRemoveHandler
      })));
    });

    _defineProperty(_assertThisInitialized(_this), "getCanSelectStatus", function (groupName, lists) {
      var isClearable = _this.props.isClearable;
      var isGroupName = String(groupName).trim() !== '';
      var count = 0;
      Object.keys(lists).forEach(function (key) {
        count += lists[key].getCheckedItemsCount();
      });

      if (isClearable && count === 0) {
        return true;
      }

      return isGroupName && count > 0;
    });

    _defineProperty(_assertThisInitialized(_this), "getCheckedOutput", function () {
      // At this moment we provide results only for one data source
      var checkedItemHashList = getFirstCheckedItemHashList(_this.state.checkedItemHashLists);
      if (!checkedItemHashList) return [];
      var checkedOutput = checkedItemHashList.getCheckedOutput();
      var resultList = checkedOutput.checked || [];
      return resultList;
    });

    _defineProperty(_assertThisInitialized(_this), "getAllCheckedItems", function () {
      // At this moment we provide results only for one data source
      var checkedItemHashList = getFirstCheckedItemHashList(_this.state.checkedItemHashLists);
      if (!checkedItemHashList) return [];
      var checkedItems = checkedItemHashList.getAllCheckedItems();
      return checkedItems;
    });

    _defineProperty(_assertThisInitialized(_this), "createCheckedItemHashLists", function (dataSourceProvider) {
      var listHash = {};
      dataSourceProvider.preCheckItems();
      listHash[dataSourceProvider.id] = dataSourceProvider.getChecked();
      return listHash;
    });

    _defineProperty(_assertThisInitialized(_this), "groupNameChangeHandler", function (newValue) {
      _this.setState({
        canSelect: _this.getCanSelectStatus(newValue, _this.state.checkedItemHashLists),
        groupName: newValue,
        groupNameChangedByUser: true
      });
    });

    _defineProperty(_assertThisInitialized(_this), "cancelHandler", function () {
      _this.props.onCancel();
    });

    _defineProperty(_assertThisInitialized(_this), "selectHandler", function (flags) {
      var onSelect = _this.props.onSelect;
      var groupName = _this.state.groupName;

      var allCheckedItems = _this.getAllCheckedItems();

      var checkedOutput = _this.getCheckedOutput(); // If there's selected items, groupName can't be empty


      if (allCheckedItems && allCheckedItems.length > 0 && groupName.trim() === '') {
        throw new Error('State groupName is empty');
      }

      onSelect(groupName, allCheckedItems, checkedOutput, flags);
    });

    _defineProperty(_assertThisInitialized(_this), "checkListChangeHandler", function (checkedItemHashList) {
      if (checkedItemHashList) {
        var lists = _this.state.checkedItemHashLists;
        lists[checkedItemHashList.getId()] = checkedItemHashList;
        /* Getting group name after lists changing */

        var groupName = _this.getGroupName(lists);

        _this.setState({
          groupName: groupName,
          canSelect: _this.getCanSelectStatus(groupName, lists),
          checkedItemHashLists: lists,
          checkedItemsLastUpdate: _this.getLastUpdateStamp()
        });
      }

      _this.afterCheckListChanged();
    });

    _defineProperty(_assertThisInitialized(_this), "itemRemoveHandler", function () {
      var lists = _this.state.checkedItemHashLists;

      var groupName = _this.getGroupName(lists);

      _this.setState({
        groupName: groupName,
        canSelect: _this.getCanSelectStatus(groupName, lists),
        checkedItemsLastUpdate: _this.getLastUpdateStamp()
      });

      _this.afterCheckListChanged();
    });

    _defineProperty(_assertThisInitialized(_this), "afterCheckListChanged", function () {
      var resultList = _this.getCheckedOutput();

      _this.props.onCheckListChanged(resultList);
    });

    _defineProperty(_assertThisInitialized(_this), "show", function () {
      return _this.getContent();
    });

    _defineProperty(_assertThisInitialized(_this), "showInModal", function () {
      return React.createElement(Modal, {
        dialogClassName: "oc-hierarchy-selector-view-dialog",
        show: _this.state.visible,
        onHide: _this.cancelHandler,
        keyboard: false,
        backdrop: "static"
      }, React.createElement(Modal.Header, null, React.createElement(ViewTopBar, {
        selectDisabled: !_this.state.canSelect,
        title: _this.props.title,
        onCancel: _this.cancelHandler,
        onSelect: _this.selectHandler,
        onHelp: _this.props.onHelp,
        btnSelectLabel: _this.props.btnSelectLabel,
        btnCancelLabel: _this.props.btnCancelLabel,
        helpDisabled: _this.props.helpDisabled
      })), React.createElement(Modal.Body, null, _this.getContent()));
    });

    props.dataSourceProvider.setPrecheckedItems(props.preCheckedItems);

    var checkedItemHashLists = _this.createCheckedItemHashLists(props.dataSourceProvider);

    _this.state = {
      canSelect: _this.getCanSelectStatus(props.groupName, checkedItemHashLists),
      groupName: props.groupName,
      groupNameChangedByUser: props.groupName.trim() !== '',
      checkedItemHashLists: checkedItemHashLists,
      checkedItemsLastUpdate: _this.getInitialLastUpdateStamp(),
      visible: true
    };
    return _this;
  }

  var _proto = HierarchySelectorView.prototype;

  _proto.render = function render() {
    return this.props.showInModal && !this.props.standalone ? this.showInModal() : this.show();
  };

  return HierarchySelectorView;
}(React.PureComponent);

export { HierarchySelectorView as default };
HierarchySelectorView.defaultProps = {
  onCancel: function onCancel() {},
  onCheckListChanged: function onCheckListChanged() {},
  onSelect: function onSelect() {},
  onHelp: function onHelp() {},
  showInModal: true,
  allLabel: 'All',
  btnSelectLabel: 'Select',
  btnCancelLabel: 'Cancel',
  groupName: '',
  groupNameLabel: 'Group name',
  groupNamePlaceHolder: 'Please, fill a group name',
  listItemRenderFunction: null,
  preCheckedItems: null,
  searchPlaceHolder: 'Search...',
  searchTooltip: null,
  selectedItemListLabel: 'Selected items',
  selectedItemRenderFunction: null,
  standalone: false,
  title: '',
  helpDisabled: true,
  hideGroupNameInput: false,
  isClearable: false
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXcvdmlldy5jb21wb25lbnQuanN4Il0sIm5hbWVzIjpbIlJlYWN0IiwiUHJvcFR5cGVzIiwiTW9kYWwiLCJWaWV3VG9wQmFyIiwiVmlld1RhYnMiLCJTZWxlY3RlZEl0ZW1zIiwiR3JvdXBOYW1lIiwicHJlQ2hlY2tlZEl0ZW1zTGlzdFNoYXBlIiwiZGF0YVNvdXJjZVByb3ZpZGVyVHlwZSIsImNhbGN1bGF0ZUdyb3VwTmFtZSIsImdldEZpcnN0Q2hlY2tlZEl0ZW1IYXNoTGlzdCIsImxpc3RzIiwiZGF0YVNvdXJjZUtleXMiLCJPYmplY3QiLCJrZXlzIiwibGVuZ3RoIiwiSGllcmFyY2h5U2VsZWN0b3JWaWV3IiwicHJvcHMiLCJzdGFtcCIsInN0YXRlIiwiY2hlY2tlZEl0ZW1IYXNoTGlzdHMiLCJtYXAiLCJpIiwiZ2V0TGFzdFVwZGF0ZVN0YW1wIiwiam9pbiIsImhhc2hMaXN0IiwiZ3JvdXBOYW1lIiwiZ3JvdXBOYW1lQ2hhbmdlZEJ5VXNlciIsImxpc3RzSGFzaEFycmF5IiwidGFic0l0ZW1zIiwidGl0bGUiLCJkYXRhU291cmNlUHJvdmlkZXIiLCJhbGxMYWJlbCIsImxpc3RJdGVtUmVuZGVyRnVuY3Rpb24iLCJjaGVja0xpc3RDaGFuZ2VIYW5kbGVyIiwic2VhcmNoUGxhY2VIb2xkZXIiLCJzZWFyY2hUb29sdGlwIiwic3RhbmRhbG9uZSIsImhpZGVHcm91cE5hbWVJbnB1dCIsImdyb3VwTmFtZUxhYmVsIiwiZ3JvdXBOYW1lUGxhY2VIb2xkZXIiLCJncm91cE5hbWVDaGFuZ2VIYW5kbGVyIiwic2VsZWN0ZWRJdGVtTGlzdExhYmVsIiwic2VsZWN0ZWRJdGVtUmVuZGVyRnVuY3Rpb24iLCJpdGVtUmVtb3ZlSGFuZGxlciIsImlzQ2xlYXJhYmxlIiwiaXNHcm91cE5hbWUiLCJTdHJpbmciLCJ0cmltIiwiY291bnQiLCJmb3JFYWNoIiwia2V5IiwiZ2V0Q2hlY2tlZEl0ZW1zQ291bnQiLCJjaGVja2VkSXRlbUhhc2hMaXN0IiwiY2hlY2tlZE91dHB1dCIsImdldENoZWNrZWRPdXRwdXQiLCJyZXN1bHRMaXN0IiwiY2hlY2tlZCIsImNoZWNrZWRJdGVtcyIsImdldEFsbENoZWNrZWRJdGVtcyIsImxpc3RIYXNoIiwicHJlQ2hlY2tJdGVtcyIsImlkIiwiZ2V0Q2hlY2tlZCIsIm5ld1ZhbHVlIiwic2V0U3RhdGUiLCJjYW5TZWxlY3QiLCJnZXRDYW5TZWxlY3RTdGF0dXMiLCJvbkNhbmNlbCIsImZsYWdzIiwib25TZWxlY3QiLCJhbGxDaGVja2VkSXRlbXMiLCJFcnJvciIsImdldElkIiwiZ2V0R3JvdXBOYW1lIiwiY2hlY2tlZEl0ZW1zTGFzdFVwZGF0ZSIsImFmdGVyQ2hlY2tMaXN0Q2hhbmdlZCIsIm9uQ2hlY2tMaXN0Q2hhbmdlZCIsImdldENvbnRlbnQiLCJ2aXNpYmxlIiwiY2FuY2VsSGFuZGxlciIsInNlbGVjdEhhbmRsZXIiLCJvbkhlbHAiLCJidG5TZWxlY3RMYWJlbCIsImJ0bkNhbmNlbExhYmVsIiwiaGVscERpc2FibGVkIiwic2V0UHJlY2hlY2tlZEl0ZW1zIiwicHJlQ2hlY2tlZEl0ZW1zIiwiY3JlYXRlQ2hlY2tlZEl0ZW1IYXNoTGlzdHMiLCJnZXRJbml0aWFsTGFzdFVwZGF0ZVN0YW1wIiwicmVuZGVyIiwic2hvd0luTW9kYWwiLCJzaG93IiwiUHVyZUNvbXBvbmVudCIsImRlZmF1bHRQcm9wcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7QUFFQSxPQUFPQSxLQUFQLE1BQWtCLE9BQWxCO0FBQ0EsT0FBT0MsU0FBUCxNQUFzQixZQUF0QjtBQUNBLFNBQVNDLEtBQVQsUUFBc0IsaUJBQXRCO0FBRUEsT0FBT0MsVUFBUCxNQUF1QixxQkFBdkI7QUFDQSxPQUFPQyxRQUFQLE1BQXFCLGtCQUFyQjtBQUNBLE9BQU9DLGFBQVAsTUFBMEIsa0JBQTFCO0FBQ0EsT0FBT0MsU0FBUCxNQUFzQixjQUF0QjtBQUNBLFNBQVNDLHdCQUFULFFBQXlDLGFBQXpDO0FBQ0EsU0FBU0Msc0JBQVQs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O0FBT25DbUQsRUFBQUEsY0FBYyxFQUFFLFFBUG1CO0FBUW5DQyxFQUFBQSxjQUFjLEVBQUUsUUFSbUI7QUFTbkMxRCxFQUFBQSxTQUFTLEVBQUUsRUFUd0I7QUFVbkNhLEVBQUFBLGNBQWMsRUFBRSxZQVZtQjtBQVduQ0MsRUFBQUEsb0JBQW9CLEVBQUUsMkJBWGE7QUFZbkNQLEVBQUFBLHNCQUFzQixFQUFFLElBWlc7QUFhbkNzRCxFQUFBQSxlQUFlLEVBQUUsSUFia0I7QUFjbkNwRCxFQUFBQSxpQkFBaUIsRUFBRSxXQWRnQjtBQWVuQ0MsRUFBQUEsYUFBYSxFQUFFLElBZm9CO0FBZ0JuQ00sRUFBQUEscUJBQXFCLEVBQUUsZ0JBaEJZO0FBaUJuQ0MsRUFBQUEsMEJBQTBCLEVBQUUsSUFqQk87QUFrQm5DTixFQUFBQSxVQUFVLEVBQUUsS0FsQnVCO0FBbUJuQ1AsRUFBQUEsS0FBSyxFQUFFLEVBbkI0QjtBQW9CbkN1RCxFQUFBQSxZQUFZLEVBQUUsSUFwQnFCO0FBcUJuQy9DLEVBQUFBLGtCQUFrQixFQUFFLEtBckJlO0FBc0JuQ08sRUFBQUEsV0FBVyxFQUFFO0FBdEJzQixDQUFyQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIHJlYWN0L25vLXVudXNlZC1zdGF0ZSAqL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCB7IE1vZGFsIH0gZnJvbSAncmVhY3QtYm9vdHN0cmFwJztcblxuaW1wb3J0IFZpZXdUb3BCYXIgZnJvbSAnLi90b3AtYmFyLmNvbXBvbmVudCc7XG5pbXBvcnQgVmlld1RhYnMgZnJvbSAnLi90YWJzLmNvbXBvbmVudCc7XG5pbXBvcnQgU2VsZWN0ZWRJdGVtcyBmcm9tICcuL3NlbGVjdGVkLWl0ZW1zJztcbmltcG9ydCBHcm91cE5hbWUgZnJvbSAnLi9ncm91cC1uYW1lJztcbmltcG9ydCB7IHByZUNoZWNrZWRJdGVtc0xpc3RTaGFwZSB9IGZyb20gJy4uLy4uL3R5cGVzJztcbmltcG9ydCB7IGRhdGFTb3VyY2VQcm92aWRlclR5cGUgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy90eXBlcyc7XG5pbXBvcnQgY2FsY3VsYXRlR3JvdXBOYW1lIGZyb20gJy4uLy4uL3NlcnZpY2VzL2dyb3VwLW5hbWUtY2FsY3VsYXRpb24nO1xuXG5pbXBvcnQgJy4vdmlldy5zY3NzJztcblxuXG5mdW5jdGlvbiBnZXRGaXJzdENoZWNrZWRJdGVtSGFzaExpc3QobGlzdHMpIHtcbiAgY29uc3QgZGF0YVNvdXJjZUtleXMgPSBPYmplY3Qua2V5cyhsaXN0cyk7XG5cbiAgaWYgKGRhdGFTb3VyY2VLZXlzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGw7XG5cbiAgcmV0dXJuIGxpc3RzW2RhdGFTb3VyY2VLZXlzWzBdXTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSGllcmFyY2h5U2VsZWN0b3JWaWV3IGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudCB7XG4gIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuXG4gICAgcHJvcHMuZGF0YVNvdXJjZVByb3ZpZGVyLnNldFByZWNoZWNrZWRJdGVtcyhwcm9wcy5wcmVDaGVja2VkSXRlbXMpO1xuICAgIGNvbnN0IGNoZWNrZWRJdGVtSGFzaExpc3RzID0gdGhpcy5jcmVhdGVDaGVja2VkSXRlbUhhc2hMaXN0cyhwcm9wcy5kYXRhU291cmNlUHJvdmlkZXIpO1xuXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGNhblNlbGVjdDogdGhpcy5nZXRDYW5TZWxlY3RTdGF0dXMocHJvcHMuZ3JvdXBOYW1lLCBjaGVja2VkSXRlbUhhc2hMaXN0cyksXG4gICAgICBncm91cE5hbWU6IHByb3BzLmdyb3VwTmFtZSxcbiAgICAgIGdyb3VwTmFtZUNoYW5nZWRCeVVzZXI6IHByb3BzLmdyb3VwTmFtZS50cmltKCkgIT09ICcnLFxuICAgICAgY2hlY2tlZEl0ZW1IYXNoTGlzdHMsXG4gICAgICBjaGVja2VkSXRlbXNMYXN0VXBkYXRlOiB0aGlzLmdldEluaXRpYWxMYXN0VXBkYXRlU3RhbXAoKSxcbiAgICAgIHZpc2libGU6IHRydWUsXG4gICAgfTtcbiAgfVxuXG4gIGdldEluaXRpYWxMYXN0VXBkYXRlU3RhbXAgPSAoKSA9PiAnMCc7XG5cbiAgZ2V0TGFzdFVwZGF0ZVN0YW1wID0gKCkgPT4ge1xuICAgIGNvbnN0IHN0YW1wID0gT2JqZWN0XG4gICAgICAua2V5cyh0aGlzLnN0YXRlLmNoZWNrZWRJdGVtSGFzaExpc3RzKVxuICAgICAgLm1hcChpID0+IHRoaXMuc3RhdGUuY2hlY2tlZEl0ZW1IYXNoTGlzdHNbaV0uZ2V0TGFzdFVwZGF0ZVN0YW1wKCkpXG4gICAgICAuam9pbignLScpO1xuXG4gICAgcmV0dXJuIHN0YW1wO1xuICB9XG5cbiAgZ2V0R3JvdXBOYW1lID0gKGhhc2hMaXN0KSA9PiB7XG4gICAgY29uc3QgeyBncm91cE5hbWUsIGdyb3VwTmFtZUNoYW5nZWRCeVVzZXIgfSA9IHRoaXMuc3RhdGU7XG4gICAgcmV0dXJuIGNhbGN1bGF0ZUdyb3VwTmFtZShncm91cE5hbWUsIGdyb3VwTmFtZUNoYW5nZWRCeVVzZXIsIGhhc2hMaXN0KTtcbiAgfVxuXG4gIGdldENvbnRlbnQgPSAoKSA9PiB7XG4gICAgY29uc3QgbGlzdHNIYXNoQXJyYXkgPSB0aGlzLnN0YXRlLmNoZWNrZWRJdGVtSGFzaExpc3RzO1xuICAgIGNvbnN0IHRhYnNJdGVtcyA9IFt7XG4gICAgICB0aXRsZTogJycsXG4gICAgICBkYXRhU291cmNlUHJvdmlkZXI6IHRoaXMucHJvcHMuZGF0YVNvdXJjZVByb3ZpZGVyLFxuICAgIH1dO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXYgY2xhc3NOYW1lPVwib2MtaGllcmFyY2h5LXNlbGVjdG9yLXZpZXdcIj5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJvYy1oaWVyYXJjaHktc2VsZWN0b3ItdGFic1wiPlxuICAgICAgICAgIDxWaWV3VGFic1xuICAgICAgICAgICAgYWxsTGFiZWw9e3RoaXMucHJvcHMuYWxsTGFiZWx9XG4gICAgICAgICAgICBpdGVtcz17dGFic0l0ZW1zfVxuICAgICAgICAgICAgbGlzdEl0ZW1SZW5kZXJGdW5jdGlvbj17dGhpcy5wcm9wcy5saXN0SXRlbVJlbmRlckZ1bmN0aW9ufVxuICAgICAgICAgICAgb25DaGVja0xpc3RDaGFuZ2U9e3RoaXMuY2hlY2tMaXN0Q2hhbmdlSGFuZGxlcn1cbiAgICAgICAgICAgIGhpZGVTaW5nbGVUYWJcbiAgICAgICAgICAgIHNlYXJjaFBsYWNlSG9sZGVyPXt0aGlzLnByb3BzLnNlYXJjaFBsYWNlSG9sZGVyfVxuICAgICAgICAgICAgc2VhcmNoVG9vbHRpcD17dGhpcy5wcm9wcy5zZWFyY2hUb29sdGlwfVxuICAgICAgICAgIC8+XG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm9jLWhpZXJhcmNoeS1zZWxlY3Rvci1zZWxlY3RlZC1jb250YWluZXJcIj5cbiAgICAgICAgICB7KCF0aGlzLnByb3BzLnN0YW5kYWxvbmUgJiYgIXRoaXMucHJvcHMuaGlkZUdyb3VwTmFtZUlucHV0KSAmJlxuICAgICAgICAgIDxHcm91cE5hbWVcbiAgICAgICAgICAgIGxhYmVsPXt0aGlzLnByb3BzLmdyb3VwTmFtZUxhYmVsfVxuICAgICAgICAgICAgcGxhY2VIb2xkZXI9e3RoaXMucHJvcHMuZ3JvdXBOYW1lUGxhY2VIb2xkZXJ9XG4gICAgICAgICAgICBpbml0aWFsVmFsdWU9e3RoaXMuc3RhdGUuZ3JvdXBOYW1lfVxuICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMuZ3JvdXBOYW1lQ2hhbmdlSGFuZGxlcn1cbiAgICAgICAgICAvPn1cbiAgICAgICAgICA8U2VsZWN0ZWRJdGVtc1xuICAgICAgICAgICAgYWxsTGFiZWw9e3RoaXMucHJvcHMuYWxsTGFiZWx9XG4gICAgICAgICAgICBsaXN0TGFiZWw9e3RoaXMucHJvcHMuc2VsZWN0ZWRJdGVtTGlzdExhYmVsfVxuICAgICAgICAgICAgY2hlY2tlZEl0ZW1MaXN0cz17T2JqZWN0LmtleXMobGlzdHNIYXNoQXJyYXkpLm1hcChpID0+IGxpc3RzSGFzaEFycmF5W2ldKX1cbiAgICAgICAgICAgIGl0ZW1SZW5kZXJGdW5jdGlvbj17dGhpcy5wcm9wcy5zZWxlY3RlZEl0ZW1SZW5kZXJGdW5jdGlvbn1cbiAgICAgICAgICAgIG9uSXRlbVJlbW92ZT17dGhpcy5pdGVtUmVtb3ZlSGFuZGxlcn1cbiAgICAgICAgICAvPlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvZGl2PlxuICAgICk7XG4gIH1cblxuICBnZXRDYW5TZWxlY3RTdGF0dXMgPSAoZ3JvdXBOYW1lLCBsaXN0cykgPT4ge1xuICAgIGNvbnN0IHsgaXNDbGVhcmFibGUgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgaXNHcm91cE5hbWUgPSBTdHJpbmcoZ3JvdXBOYW1lKS50cmltKCkgIT09ICcnO1xuICAgIGxldCBjb3VudCA9IDA7XG4gICAgT2JqZWN0LmtleXMobGlzdHMpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgY291bnQgKz0gbGlzdHNba2V5XS5nZXRDaGVja2VkSXRlbXNDb3VudCgpO1xuICAgIH0pO1xuXG4gICAgaWYgKGlzQ2xlYXJhYmxlICYmIGNvdW50ID09PSAwKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gaXNHcm91cE5hbWUgJiYgY291bnQgPiAwO1xuICB9XG5cbiAgZ2V0Q2hlY2tlZE91dHB1dCA9ICgpID0+IHtcbiAgICAvLyBBdCB0aGlzIG1vbWVudCB3ZSBwcm92aWRlIHJlc3VsdHMgb25seSBmb3Igb25lIGRhdGEgc291cmNlXG4gICAgY29uc3QgY2hlY2tlZEl0ZW1IYXNoTGlzdCA9IGdldEZpcnN0Q2hlY2tlZEl0ZW1IYXNoTGlzdCh0aGlzLnN0YXRlLmNoZWNrZWRJdGVtSGFzaExpc3RzKTtcbiAgICBpZiAoIWNoZWNrZWRJdGVtSGFzaExpc3QpIHJldHVybiBbXTtcblxuICAgIGNvbnN0IGNoZWNrZWRPdXRwdXQgPSBjaGVja2VkSXRlbUhhc2hMaXN0LmdldENoZWNrZWRPdXRwdXQoKTtcbiAgICBjb25zdCByZXN1bHRMaXN0ID0gY2hlY2tlZE91dHB1dC5jaGVja2VkIHx8IFtdO1xuXG4gICAgcmV0dXJuIHJlc3VsdExpc3Q7XG4gIH1cblxuICBnZXRBbGxDaGVja2VkSXRlbXMgPSAoKSA9PiB7XG4gICAgLy8gQXQgdGhpcyBtb21lbnQgd2UgcHJvdmlkZSByZXN1bHRzIG9ubHkgZm9yIG9uZSBkYXRhIHNvdXJjZVxuICAgIGNvbnN0IGNoZWNrZWRJdGVtSGFzaExpc3QgPSBnZXRGaXJzdENoZWNrZWRJdGVtSGFzaExpc3QodGhpcy5zdGF0ZS5jaGVja2VkSXRlbUhhc2hMaXN0cyk7XG4gICAgaWYgKCFjaGVja2VkSXRlbUhhc2hMaXN0KSByZXR1cm4gW107XG5cbiAgICBjb25zdCBjaGVja2VkSXRlbXMgPSBjaGVja2VkSXRlbUhhc2hMaXN0LmdldEFsbENoZWNrZWRJdGVtcygpO1xuXG4gICAgcmV0dXJuIGNoZWNrZWRJdGVtcztcbiAgfVxuXG4gIGNyZWF0ZUNoZWNrZWRJdGVtSGFzaExpc3RzID0gKGRhdGFTb3VyY2VQcm92aWRlcikgPT4ge1xuICAgIGNvbnN0IGxpc3RIYXNoID0ge307XG5cbiAgICBkYXRhU291cmNlUHJvdmlkZXIucHJlQ2hlY2tJdGVtcygpO1xuICAgIGxpc3RIYXNoW2RhdGFTb3VyY2VQcm92aWRlci5pZF0gPSBkYXRhU291cmNlUHJvdmlkZXIuZ2V0Q2hlY2tlZCgpO1xuXG4gICAgcmV0dXJuIGxpc3RIYXNoO1xuICB9XG5cbiAgZ3JvdXBOYW1lQ2hhbmdlSGFuZGxlciA9IChuZXdWYWx1ZSkgPT4ge1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgY2FuU2VsZWN0OiB0aGlzLmdldENhblNlbGVjdFN0YXR1cyhuZXdWYWx1ZSwgdGhpcy5zdGF0ZS5jaGVja2VkSXRlbUhhc2hMaXN0cyksXG4gICAgICBncm91cE5hbWU6IG5ld1ZhbHVlLFxuICAgICAgZ3JvdXBOYW1lQ2hhbmdlZEJ5VXNlcjogdHJ1ZSxcbiAgICB9KTtcbiAgfVxuXG4gIGNhbmNlbEhhbmRsZXIgPSAoKSA9PiB7XG4gICAgdGhpcy5wcm9wcy5vbkNhbmNlbCgpO1xuICB9XG5cbiAgc2VsZWN0SGFuZGxlciA9IChmbGFncykgPT4ge1xuICAgIGNvbnN0IHsgb25TZWxlY3QgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgeyBncm91cE5hbWUgfSA9IHRoaXMuc3RhdGU7XG5cbiAgICBjb25zdCBhbGxDaGVja2VkSXRlbXMgPSB0aGlzLmdldEFsbENoZWNrZWRJdGVtcygpO1xuICAgIGNvbnN0IGNoZWNrZWRPdXRwdXQgPSB0aGlzLmdldENoZWNrZWRPdXRwdXQoKTtcblxuICAgIC8vIElmIHRoZXJlJ3Mgc2VsZWN0ZWQgaXRlbXMsIGdyb3VwTmFtZSBjYW4ndCBiZSBlbXB0eVxuICAgIGlmIChhbGxDaGVja2VkSXRlbXMgJiYgYWxsQ2hlY2tlZEl0ZW1zLmxlbmd0aCA+IDAgJiYgZ3JvdXBOYW1lLnRyaW0oKSA9PT0gJycpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignU3RhdGUgZ3JvdXBOYW1lIGlzIGVtcHR5Jyk7XG4gICAgfVxuXG4gICAgb25TZWxlY3QoZ3JvdXBOYW1lLCBhbGxDaGVja2VkSXRlbXMsIGNoZWNrZWRPdXRwdXQsIGZsYWdzKTtcbiAgfVxuXG4gIGNoZWNrTGlzdENoYW5nZUhhbmRsZXIgPSAoY2hlY2tlZEl0ZW1IYXNoTGlzdCkgPT4ge1xuICAgIGlmIChjaGVja2VkSXRlbUhhc2hMaXN0KSB7XG4gICAgICBjb25zdCBsaXN0cyA9IHRoaXMuc3RhdGUuY2hlY2tlZEl0ZW1IYXNoTGlzdHM7XG4gICAgICBsaXN0c1tjaGVja2VkSXRlbUhhc2hMaXN0LmdldElkKCldID0gY2hlY2tlZEl0ZW1IYXNoTGlzdDtcbiAgICAgIC8qIEdldHRpbmcgZ3JvdXAgbmFtZSBhZnRlciBsaXN0cyBjaGFuZ2luZyAqL1xuICAgICAgY29uc3QgZ3JvdXBOYW1lID0gdGhpcy5nZXRHcm91cE5hbWUobGlzdHMpO1xuXG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgZ3JvdXBOYW1lLFxuICAgICAgICBjYW5TZWxlY3Q6IHRoaXMuZ2V0Q2FuU2VsZWN0U3RhdHVzKGdyb3VwTmFtZSwgbGlzdHMpLFxuICAgICAgICBjaGVja2VkSXRlbUhhc2hMaXN0czogbGlzdHMsXG4gICAgICAgIGNoZWNrZWRJdGVtc0xhc3RVcGRhdGU6IHRoaXMuZ2V0TGFzdFVwZGF0ZVN0YW1wKCksXG4gICAgICB9KTtcbiAgICB9XG4gICAgdGhpcy5hZnRlckNoZWNrTGlzdENoYW5nZWQoKTtcbiAgfVxuXG4gIGl0ZW1SZW1vdmVIYW5kbGVyID0gKCkgPT4ge1xuICAgIGNvbnN0IGxpc3RzID0gdGhpcy5zdGF0ZS5jaGVja2VkSXRlbUhhc2hMaXN0cztcbiAgICBjb25zdCBncm91cE5hbWUgPSB0aGlzLmdldEdyb3VwTmFtZShsaXN0cyk7XG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBncm91cE5hbWUsXG4gICAgICBjYW5TZWxlY3Q6IHRoaXMuZ2V0Q2FuU2VsZWN0U3RhdHVzKGdyb3VwTmFtZSwgbGlzdHMpLFxuICAgICAgY2hlY2tlZEl0ZW1zTGFzdFVwZGF0ZTogdGhpcy5nZXRMYXN0VXBkYXRlU3RhbXAoKSxcbiAgICB9KTtcbiAgICB0aGlzLmFmdGVyQ2hlY2tMaXN0Q2hhbmdlZCgpO1xuICB9XG5cbiAgYWZ0ZXJDaGVja0xpc3RDaGFuZ2VkID0gKCkgPT4ge1xuICAgIGNvbnN0IHJlc3VsdExpc3QgPSB0aGlzLmdldENoZWNrZWRPdXRwdXQoKTtcbiAgICB0aGlzLnByb3BzLm9uQ2hlY2tMaXN0Q2hhbmdlZChyZXN1bHRMaXN0KTtcbiAgfVxuXG4gIHNob3cgPSAoKSA9PiB0aGlzLmdldENvbnRlbnQoKTtcblxuICBzaG93SW5Nb2RhbCA9ICgpID0+IChcbiAgICA8TW9kYWxcbiAgICAgIGRpYWxvZ0NsYXNzTmFtZT1cIm9jLWhpZXJhcmNoeS1zZWxlY3Rvci12aWV3LWRpYWxvZ1wiXG4gICAgICBzaG93PXt0aGlzLnN0YXRlLnZpc2libGV9XG4gICAgICBvbkhpZGU9e3RoaXMuY2FuY2VsSGFuZGxlcn1cbiAgICAgIGtleWJvYXJkPXtmYWxzZX1cbiAgICAgIGJhY2tkcm9wPVwic3RhdGljXCJcbiAgICA+XG4gICAgICA8TW9kYWwuSGVhZGVyPlxuICAgICAgICA8Vmlld1RvcEJhclxuICAgICAgICAgIHNlbGVjdERpc2FibGVkPXshdGhpcy5zdGF0ZS5jYW5TZWxlY3R9XG4gICAgICAgICAgdGl0bGU9e3RoaXMucHJvcHMudGl0bGV9XG4gICAgICAgICAgb25DYW5jZWw9e3RoaXMuY2FuY2VsSGFuZGxlcn1cbiAgICAgICAgICBvblNlbGVjdD17dGhpcy5zZWxlY3RIYW5kbGVyfVxuICAgICAgICAgIG9uSGVscD17dGhpcy5wcm9wcy5vbkhlbHB9XG4gICAgICAgICAgYnRuU2VsZWN0TGFiZWw9e3RoaXMucHJvcHMuYnRuU2VsZWN0TGFiZWx9XG4gICAgICAgICAgYnRuQ2FuY2VsTGFiZWw9e3RoaXMucHJvcHMuYnRuQ2FuY2VsTGFiZWx9XG4gICAgICAgICAgaGVscERpc2FibGVkPXt0aGlzLnByb3BzLmhlbHBEaXNhYmxlZH1cbiAgICAgICAgLz5cbiAgICAgIDwvTW9kYWwuSGVhZGVyPlxuICAgICAgPE1vZGFsLkJvZHk+XG4gICAgICAgIHt0aGlzLmdldENvbnRlbnQoKX1cbiAgICAgIDwvTW9kYWwuQm9keT5cbiAgICA8L01vZGFsPlxuICApO1xuXG4gIHJlbmRlcigpIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy5zaG93SW5Nb2RhbCAmJiAhdGhpcy5wcm9wcy5zdGFuZGFsb25lID8gdGhpcy5zaG93SW5Nb2RhbCgpIDogdGhpcy5zaG93KCk7XG4gIH1cbn1cblxuSGllcmFyY2h5U2VsZWN0b3JWaWV3LnByb3BUeXBlcyA9IHtcbiAgZGF0YVNvdXJjZVByb3ZpZGVyOiBkYXRhU291cmNlUHJvdmlkZXJUeXBlLmlzUmVxdWlyZWQsXG4gIG9uQ2FuY2VsOiBQcm9wVHlwZXMuZnVuYyxcbiAgb25DaGVja0xpc3RDaGFuZ2VkOiBQcm9wVHlwZXMuZnVuYyxcbiAgb25TZWxlY3Q6IFByb3BUeXBlcy5mdW5jLFxuICBvbkhlbHA6IFByb3BUeXBlcy5mdW5jLFxuICBzaG93SW5Nb2RhbDogUHJvcFR5cGVzLmJvb2wsXG4gIHRpdGxlOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMuc3RyaW5nLCBQcm9wVHlwZXMuZWxlbWVudF0pLFxuICBhbGxMYWJlbDogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLnN0cmluZywgUHJvcFR5cGVzLmVsZW1lbnRdKSxcbiAgYnRuU2VsZWN0TGFiZWw6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1Byb3BUeXBlcy5zdHJpbmcsIFByb3BUeXBlcy5lbGVtZW50XSksXG4gIGJ0bkNhbmNlbExhYmVsOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMuc3RyaW5nLCBQcm9wVHlwZXMuZWxlbWVudF0pLFxuICBncm91cE5hbWU6IFByb3BUeXBlcy5zdHJpbmcsXG4gIGdyb3VwTmFtZUxhYmVsOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMuc3RyaW5nLCBQcm9wVHlwZXMuZWxlbWVudF0pLFxuICBncm91cE5hbWVQbGFjZUhvbGRlcjogUHJvcFR5cGVzLnN0cmluZyxcbiAgbGlzdEl0ZW1SZW5kZXJGdW5jdGlvbjogUHJvcFR5cGVzLmZ1bmMsXG4gIHByZUNoZWNrZWRJdGVtczogcHJlQ2hlY2tlZEl0ZW1zTGlzdFNoYXBlLFxuICBzZWFyY2hQbGFjZUhvbGRlcjogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLnN0cmluZywgUHJvcFR5cGVzLmVsZW1lbnRdKSxcbiAgc2VhcmNoVG9vbHRpcDogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLmVsZW1lbnQsIFByb3BUeXBlcy5zdHJpbmddKSxcbiAgc2VsZWN0ZWRJdGVtTGlzdExhYmVsOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMuc3RyaW5nLCBQcm9wVHlwZXMuZWxlbWVudF0pLFxuICBzZWxlY3RlZEl0ZW1SZW5kZXJGdW5jdGlvbjogUHJvcFR5cGVzLmZ1bmMsXG4gIHN0YW5kYWxvbmU6IFByb3BUeXBlcy5ib29sLFxuICBoZWxwRGlzYWJsZWQ6IFByb3BUeXBlcy5ib29sLFxuICBoaWRlR3JvdXBOYW1lSW5wdXQ6IFByb3BUeXBlcy5ib29sLFxuICBpc0NsZWFyYWJsZTogUHJvcFR5cGVzLmJvb2wsXG59O1xuXG5IaWVyYXJjaHlTZWxlY3RvclZpZXcuZGVmYXVsdFByb3BzID0ge1xuICBvbkNhbmNlbDogKCkgPT4ge30sXG4gIG9uQ2hlY2tMaXN0Q2hhbmdlZDogKCkgPT4ge30sXG4gIG9uU2VsZWN0OiAoKSA9PiB7fSxcbiAgb25IZWxwOiAoKSA9PiB7fSxcbiAgc2hvd0luTW9kYWw6IHRydWUsXG4gIGFsbExhYmVsOiAnQWxsJyxcbiAgYnRuU2VsZWN0TGFiZWw6ICdTZWxlY3QnLFxuICBidG5DYW5jZWxMYWJlbDogJ0NhbmNlbCcsXG4gIGdyb3VwTmFtZTogJycsXG4gIGdyb3VwTmFtZUxhYmVsOiAnR3JvdXAgbmFtZScsXG4gIGdyb3VwTmFtZVBsYWNlSG9sZGVyOiAnUGxlYXNlLCBmaWxsIGEgZ3JvdXAgbmFtZScsXG4gIGxpc3RJdGVtUmVuZGVyRnVuY3Rpb246IG51bGwsXG4gIHByZUNoZWNrZWRJdGVtczogbnVsbCxcbiAgc2VhcmNoUGxhY2VIb2xkZXI6ICdTZWFyY2guLi4nLFxuICBzZWFyY2hUb29sdGlwOiBudWxsLFxuICBzZWxlY3RlZEl0ZW1MaXN0TGFiZWw6ICdTZWxlY3RlZCBpdGVtcycsXG4gIHNlbGVjdGVkSXRlbVJlbmRlckZ1bmN0aW9uOiBudWxsLFxuICBzdGFuZGFsb25lOiBmYWxzZSxcbiAgdGl0bGU6ICcnLFxuICBoZWxwRGlzYWJsZWQ6IHRydWUsXG4gIGhpZGVHcm91cE5hbWVJbnB1dDogZmFsc2UsXG4gIGlzQ2xlYXJhYmxlOiBmYWxzZSxcbn07XG4iXX0=